<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‚¬ì§„ ê°¤ëŸ¬ë¦¬ í¸ì§‘ â€“ OnFilm</title>

  <style>
    :root{
      --bg:#0b0c0f;
      --panel:#12131a;
      --panel-2:#161824;
      --text:#e7e8ee;
      --muted:#9aa0ad;
      --line:rgba(255,255,255,.12);
      --accent:#7c5cff;
      --accent-2:#24d39a;
      --radius-lg:14px;
      --radius-md:10px;
      --shadow:0 10px 40px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
      background:
              radial-gradient(900px 400px at 80% 0%, rgba(124,92,255,.2), transparent 60%),
              radial-gradient(700px 350px at 10% 10%, rgba(36,211,154,.15), transparent 60%),
              var(--bg);
      color:var(--text);
    }

    .page-shell{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    header{
      width:100%;
      border-bottom:1px solid var(--line);
      background:rgba(11,12,15,.9);
      backdrop-filter:blur(8px);
    }
    .header-inner{
      width:min(1100px,92vw);
      margin:0 auto;
      padding:14px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .header-title{
      font-size:16px;
      font-weight:700;
    }
    .back-link{
      font-size:13px;
      color:var(--muted);
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .back-link:hover{ color:var(--text); }

    main{
      flex:1;
      width:min(1100px,92vw);
      margin:0 auto;
      padding:26px 0 40px;
    }

    .edit-card{
      background:var(--panel);
      border-radius:var(--radius-lg);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      padding:22px 20px 24px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    .section-title{
      font-size:14px;
      font-weight:600;
      margin-bottom:4px;
    }
    .section-hint{
      font-size:12px;
      color:var(--muted);
    }

    /* ì—…ë¡œë“œ ì˜ì—­ (ë“œë˜ê·¸ ì•¤ ë“œë¡­) */
    .upload-area{
      margin-top:12px;
      padding:18px 16px;
      border-radius:var(--radius-lg);
      border:1px dashed rgba(255,255,255,.25);
      background:linear-gradient(
              135deg,
              rgba(124,92,255,.14),
              rgba(17,19,30,1)
      );
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      text-align:center;
      transition:border-color .15s ease, background .15s ease;
    }
    .upload-area.dragover{
      border-color:var(--accent-2);
      background:linear-gradient(
              135deg,
              rgba(36,211,154,.18),
              rgba(17,19,30,1)
      );
    }
    .upload-icon{ font-size:26px; }
    .upload-main-text{ font-size:13px; font-weight:500; }
    .upload-sub-text{ font-size:11px; color:var(--muted); }

    .upload-actions{
      display:flex;
      gap:8px;
      margin-top:4px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      padding:6px 14px;
      font-size:12px;
      cursor:pointer;
      color:var(--text);
    }
    .btn.primary{
      border-color:var(--accent);
      background:var(--accent);
      color:#fff;
    }
    .btn.primary:hover{ background:#8a6dff; }
    .btn:hover{ border-color:var(--accent); }

    .hidden-input{ display:none; }

    /* ê°¤ëŸ¬ë¦¬ */
    .gallery-wrapper{ margin-top:10px; }

    .gallery-toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
    }

    .gallery-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
      gap:10px;
    }

    .photo-card{
      position:relative;
      border-radius:var(--radius-md);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:var(--panel-2);
      cursor:grab;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .photo-card.dragging{
      opacity:.7;
      transform:scale(.98);
      box-shadow:0 14px 40px rgba(0,0,0,.7);
      border-color:var(--accent-2);
      cursor:grabbing;
    }
    .photo-thumb{
      width:100%;
      height:150px;
      object-fit:cover;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
    }

    .photo-bottom-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:5px 7px;
      font-size:11px;
      background:linear-gradient(to top, rgba(0,0,0,.8), rgba(0,0,0,.2));
      position:absolute;
      left:0;
      right:0;
      bottom:0;
    }

    .photo-handle{
      display:inline-flex;
      align-items:center;
      gap:3px;
      color:var(--muted);
      font-size:11px;
      pointer-events:none; /* í•¸ë“¤ ì˜ì—­ í´ë¦­/ë“œë˜ê·¸ëŠ” ì¹´ë“œê°€ ë¨¹ê²Œ */
    }
    .dots-icon{ font-size:14px; line-height:1; }

    .photo-delete-btn{
      border:0;
      padding:0;
      width:22px;
      height:22px;
      border-radius:999px;
      background:rgba(0,0,0,.7);
      color:#ffb3b3;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .photo-delete-btn:hover{
      background:rgba(255,80,80,.9);
      color:#fff;
    }

    .empty-hint{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      padding:16px 0 4px;
    }

    .form-actions{
      margin-top:16px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .primary-btn,
    .ghost-btn{
      min-width:90px;
      padding:7px 13px;
      border-radius:999px;
      border:0;
      font-size:13px;
      cursor:pointer;
    }
    .primary-btn{ background:var(--accent); color:white; }
    .primary-btn:hover{ background:#8a6dff; }
    .ghost-btn{
      background:transparent;
      color:var(--muted);
      border:1px solid var(--line);
    }
    .ghost-btn:hover{
      border-color:var(--accent);
      color:var(--text);
    }

    footer{
      width:100%;
      border-top:1px solid var(--line);
      padding:18px 0 22px;
      margin-top:auto;
      text-align:center;
      font-size:11px;
      color:var(--muted);
    }

    @media (max-width:800px){
      .edit-card{ padding:18px 14px 20px; }
    }
  </style>
</head>

<body>
<div class="page-shell">
  <header>
    <div class="header-inner">
      <a href="#" class="back-link" id="backToProfileLink">â† í”„ë¡œí•„ë¡œ ëŒì•„ê°€ê¸°</a>
      <div class="header-title">ì‚¬ì§„ ê°¤ëŸ¬ë¦¬ í¸ì§‘</div>
      <div style="width:70px;"></div>
    </div>
  </header>

  <main>
    <section class="edit-card">
      <div>
        <div class="section-title">ì‚¬ì§„ ê°¤ëŸ¬ë¦¬</div>
        <div class="section-hint">
          ì´¬ì˜ ìŠ¤í‹¸ì»·, í”„ë¡œí•„ ì‚¬ì§„ ë“± ë°°ìš°ì˜ ì´ë¯¸ì§€ë¥¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆëŠ” ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.
          (ì—¬ëŸ¬ ì¥ ì—…ë¡œë“œ ê°€ëŠ¥, ìˆœì„œ ë³€ê²½ ê°€ëŠ¥)
        </div>
      </div>

      <section>
        <div id="uploadArea" class="upload-area">
          <div class="upload-icon">ğŸ“·</div>
          <div class="upload-main-text">
            ì‚¬ì§„ì„ ì´ ì˜ì—­ìœ¼ë¡œ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜, ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.
          </div>
          <div class="upload-sub-text">
            JPG, PNG / í•œ ë²ˆì— ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥
          </div>

          <div class="upload-actions">
            <button type="button" id="browseBtn" class="btn primary">íŒŒì¼ ì„ íƒ</button>
            <button type="button" id="clearAllBtn" class="btn">ì „ì²´ ë¹„ìš°ê¸°</button>
          </div>

          <input id="fileInput" class="hidden-input" type="file" accept="image/*" multiple />
        </div>
      </section>

      <section class="gallery-wrapper">
        <div class="gallery-toolbar">
          <span id="photoCountText">ì‚¬ì§„ 0ì¥</span>
          <span>ì¸ë„¤ì¼/ì‚¬ì§„ì„ ë“œë˜ê·¸í•´ì„œ ìˆœì„œë¥¼ ì¬ë°°ì¹˜í•  ìˆ˜ ìˆì–´ìš”.</span>
        </div>

        <div id="galleryGrid" class="gallery-grid"></div>

        <div id="emptyHint" class="empty-hint">
          ì•„ì§ ì—…ë¡œë“œëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </section>

      <div class="form-actions">
        <button type="button" class="ghost-btn" onclick="history.back()">ì·¨ì†Œ</button>
        <button type="button" id="saveBtn" class="primary-btn">ì €ì¥</button>
      </div>
    </section>
  </main>

  <footer>Â© 2025 OnFilm Â· Indie Actor & Film Platform</footer>
</div>

<script src="/js/auth.js"></script>

<script>
  /* =========================================================
     0) AUTH READY
  ========================================================= */
  window.__ONFILM_AUTH_READY_PROMISE__ = (async () => {
    try {
      if (!window.OnfilmAuth?.restoreSession) return { ok:false, me:null };
      return await window.OnfilmAuth.restoreSession();
    } catch (e) {
      console.error("restoreSession failed:", e);
      return { ok:false, me:null };
    }
  })();

  /* =========================================================
     1) username -> publicId helper (ìš”ì²­ ë°˜ì˜)
        - /api/person/{username} -> { publicId: "..." }
  ========================================================= */
  async function getUsernameSafe() {
    let me = window.OnfilmAuth?.getMe?.() || null;
    if (!me || !me.username) {
      const r = await window.OnfilmAuth?.restoreSession?.().catch(() => null);
      me = r?.me || me;
    }
    const uname = me?.username ? String(me.username).trim() : "";
    return uname || null;
  }

  async function fetchPublicIdByUsername(username) {
    const res = await window.OnfilmAuth.apiFetchWithAutoRefresh(
            `/api/person/${encodeURIComponent(username)}`,
            { method:"GET", headers:{ "Accept":"application/json" } }
    );
    if (!res.ok) return null;
    const data = await res.json().catch(() => null);
    return data?.publicId != null ? String(data.publicId) : null;
  }

  async function fetchGalleryByPublicId(publicId) {
    const res = await window.OnfilmAuth.apiFetchWithAutoRefresh(
            `/api/people/${encodeURIComponent(publicId)}/gallery`,
            { method:"GET", headers:{ "Accept":"application/json" } }
    );
    if (!res.ok) return [];
    const data = await res.json().catch(() => []);
    return Array.isArray(data) ? data : [];
  }

  function toStorageKey(value) {
    if (!value) return null;
    let s = String(value).trim();
    if (!s) return null;

    if (s.startsWith("http://") || s.startsWith("https://")) {
      try {
        s = new URL(s).pathname;
      } catch {
        return null;
      }
    }

    if (s.startsWith("/files/")) s = s.substring("/files/".length);
    if (s.startsWith("/")) s = s.substring(1);
    return s;
  }
</script>

<script>
  // =========================
  // ìƒíƒœ: ë©”ëª¨ë¦¬ ìƒì˜ ì‚¬ì§„ ë¦¬ìŠ¤íŠ¸
  // =========================
  /**
   * photos = [
   *   { id: 'local-1', file: File, previewUrl: 'blob:...', s3Key: null | 'xxx' }
   * ]
   */
  let photos = [];
  let idCounter = 0;
  let currentPublicId = null;

  const uploadArea     = document.getElementById("uploadArea");
  const fileInput      = document.getElementById("fileInput");
  const browseBtn      = document.getElementById("browseBtn");
  const clearAllBtn    = document.getElementById("clearAllBtn");
  const galleryGrid    = document.getElementById("galleryGrid");
  const emptyHint      = document.getElementById("emptyHint");
  const photoCountText = document.getElementById("photoCountText");
  const saveBtn        = document.getElementById("saveBtn");

  // =========================
  // ì—…ë¡œë“œ ì²˜ë¦¬
  // =========================
  function handleFiles(files) {
    const arr = Array.from(files);
    arr.forEach(file => {
      if (!file.type.startsWith("image/")) return;

      const id = `local-${++idCounter}`;
      const previewUrl = URL.createObjectURL(file);

      photos.push({ id, file, previewUrl, s3Key: null });
    });

    renderGallery();
  }

  browseBtn.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", (e) => {
    if (!e.target.files || e.target.files.length === 0) return;
    handleFiles(e.target.files);
    fileInput.value = "";
  });

  // ì—…ë¡œë“œ ì˜ì—­ ë“œë˜ê·¸ì•¤ë“œë¡­
  ["dragenter","dragover"].forEach(eventName => {
    uploadArea.addEventListener(eventName, (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.add("dragover");
    });
  });
  ["dragleave","drop"].forEach(eventName => {
    uploadArea.addEventListener(eventName, (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove("dragover");
    });
  });
  uploadArea.addEventListener("drop", (e) => {
    const dt = e.dataTransfer;
    if (!dt) return;
    const files = dt.files;
    if (files && files.length > 0) handleFiles(files);
  });

  clearAllBtn.addEventListener("click", async () => {
    if (!photos.length) return;
    if (!confirm("ì—…ë¡œë“œëœ ëª¨ë“  ì‚¬ì§„ì„ ì œê±°í• ê¹Œìš”?")) return;

    if (currentPublicId) {
      for (const p of photos) {
        if (p.s3Key) {
          await deleteGalleryImage(currentPublicId, p.s3Key).catch(() => null);
        }
      }
    }

    photos.forEach(p => p.previewUrl && URL.revokeObjectURL(p.previewUrl));
    photos = [];
    renderGallery();
  });

  // =========================
  // ê°¤ëŸ¬ë¦¬ ë Œë”ë§
  // =========================
  function renderGallery() {
    galleryGrid.innerHTML = "";

    emptyHint.style.display = (photos.length === 0) ? "block" : "none";
    photoCountText.textContent = `ì‚¬ì§„ ${photos.length}ì¥`;

    photos.forEach((photo, index) => {
      const card = document.createElement("div");
      card.className = "photo-card";
      card.draggable = true;
      card.dataset.id = photo.id;

      const img = document.createElement("img");
      img.className = "photo-thumb";
      img.src = photo.previewUrl;
      img.alt = `ì‚¬ì§„ ${index + 1}`;

      // âœ… ì´ë¯¸ì§€ ìì²´ ê¸°ë³¸ drag ë™ì‘(ìƒˆ íƒ­ ì—´ë¦¼/ë“œë˜ê·¸ ê³ ìŠ¤íŠ¸ ì´ë¯¸ì§€ ì´ìƒ) ë°©ì§€
      img.addEventListener("dragstart", (e) => {
        // cardê°€ drag ì´ë²¤íŠ¸ë¥¼ ë‹´ë‹¹í•˜ë¯€ë¡œ ì´ë¯¸ì§€ ê¸°ë³¸ ë™ì‘ì€ ë§‰ìŒ
        e.preventDefault();
      });

      const bottomBar = document.createElement("div");
      bottomBar.className = "photo-bottom-bar";

      const handle = document.createElement("div");
      handle.className = "photo-handle";
      handle.innerHTML = `<span class="dots-icon">â‹®â‹®</span><span>ë“œë˜ê·¸</span>`;

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "photo-delete-btn";
      delBtn.textContent = "âœ•";
      delBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        deletePhoto(photo.id);
      });

      bottomBar.appendChild(handle);
      bottomBar.appendChild(delBtn);

      card.appendChild(img);
      card.appendChild(bottomBar);

      addDragAndDropHandlers(card);

      galleryGrid.appendChild(card);
    });
  }

  async function deletePhoto(id) {
    const idx = photos.findIndex(p => p.id === id);
    if (idx === -1) return;
    const [removed] = photos.splice(idx, 1);
    if (removed?.s3Key && currentPublicId) {
      await deleteGalleryImage(currentPublicId, removed.s3Key).catch(() => null);
    }
    if (removed?.previewUrl) URL.revokeObjectURL(removed.previewUrl);
    renderGallery();
  }

  // =========================
  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì •ë ¬ (ì¢Œ/ìš° ì´ë™ ê°œì„ )
  // =========================
  let draggedCard = null;

  function getDragAfterElement(container, x, y, excludeEl) {
    const cards = [...container.querySelectorAll(".photo-card:not(.dragging)")];

    let closest = { offset: Number.NEGATIVE_INFINITY, element: null };

    for (const child of cards) {
      if (child === excludeEl) continue;

      const rect = child.getBoundingClientRect();

      // ì¹´ë“œ ì¤‘ì‹¬ì ê³¼ í˜„ì¬ í¬ì¸í„° ì‚¬ì´ ê±°ë¦¬ ê¸°ë°˜(ê·¸ë¦¬ë“œ ì¢Œìš° ì´ë™ì— ê°•í•¨)
      const cx = rect.left + rect.width / 2;
      const cy = rect.top  + rect.height / 2;

      // ê°€ì¤‘ì¹˜: xë¥¼ ë” ê°•í•˜ê²Œ ë´„(ì¢Œìš° ë“œë˜ê·¸ ê°œì„ )
      const dx = Math.abs(x - cx);
      const dy = Math.abs(y - cy);
      const dist = dx * 1.2 + dy * 0.8;

      // ê°€ì¥ ê°€ê¹Œìš´ ì¹´ë“œê°€ target
      const score = -dist;
      if (score > closest.offset) {
        closest = { offset: score, element: child };
      }
    }
    return closest.element;
  }

  function shouldInsertAfter(targetEl, x) {
    const rect = targetEl.getBoundingClientRect();
    return x > (rect.left + rect.width / 2);
  }

  function addDragAndDropHandlers(card){
    card.addEventListener("dragstart", (e) => {
      draggedCard = card;
      card.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", card.dataset.id); // firefox
    });

    card.addEventListener("dragend", () => {
      if (!draggedCard) return;
      draggedCard.classList.remove("dragging");
      draggedCard = null;
      syncPhotosOrderWithDOM();
    });

    // âœ… í•µì‹¬: ê¸°ì¡´ y ê¸°ì¤€/ë°˜ìª½ ê¸°ì¤€ì„ ë²„ë¦¬ê³ , "ê°€ì¥ ê°€ê¹Œìš´ ì¹´ë“œ" ê¸°ì¤€ìœ¼ë¡œ ì‚½ì…
    card.addEventListener("dragover", (e) => {
      e.preventDefault();
      if (!draggedCard) return;

      const target = getDragAfterElement(galleryGrid, e.clientX, e.clientY, draggedCard);
      if (!target) return;

      if (target === draggedCard) return;

      const after = shouldInsertAfter(target, e.clientX);
      if (after) {
        if (target.nextSibling !== draggedCard) {
          galleryGrid.insertBefore(draggedCard, target.nextSibling);
        }
      } else {
        if (target !== draggedCard) {
          galleryGrid.insertBefore(draggedCard, target);
        }
      }
    });

    card.addEventListener("drop", (e) => {
      e.preventDefault();
    });
  }

  function syncPhotosOrderWithDOM() {
    const domCards = Array.from(galleryGrid.children);
    const newOrder = domCards
            .map(card => photos.find(p => p.id === card.dataset.id))
            .filter(Boolean);

    if (newOrder.length === photos.length) photos = newOrder;
  }

  // =========================
  // ì €ì¥ ë²„íŠ¼ (í˜„ì¬ëŠ” payload ì½˜ì†” ì¶œë ¥)
  // =========================
  saveBtn.addEventListener("click", async () => {
    if (!photos.length) {
      alert("ìµœì†Œ 1ì¥ ì´ìƒì˜ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
      return;
    }

    if (!currentPublicId) {
      alert("publicIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.");
      return;
    }

    await uploadPendingPhotos();
    await reorderGallery(currentPublicId);

    alert("ê°¤ëŸ¬ë¦¬ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
  });

  // =========================
  // INIT
  // =========================
  document.addEventListener("DOMContentLoaded", async () => {
    const result = await window.__ONFILM_AUTH_READY_PROMISE__;
    if (!result?.ok) {
      const next = encodeURIComponent(location.pathname + location.search);
      location.href = `/login.html?next=${next}`;
      return;
    }

    const uname = await getUsernameSafe();
    currentPublicId = uname ? await fetchPublicIdByUsername(uname) : null;
    if (currentPublicId) {
      const urls = await fetchGalleryByPublicId(currentPublicId);
      photos = urls.map((url) => ({
        id: `remote-${++idCounter}`,
        file: null,
        previewUrl: url,
        s3Key: toStorageKey(url),
      }));
    }

    renderGallery();

    // âœ… ì „ì²´ ë“œë¡­ ê¸°ë³¸ ë™ì‘ ë°©ì§€(í˜ì´ì§€ ì´ë™/ìƒˆ íƒ­ ì—´ë¦¼ ë°©ì§€)
    window.addEventListener("dragover", (e) => e.preventDefault());
    window.addEventListener("drop", (e) => e.preventDefault());
  });
</script>

<script>
  async function uploadPendingPhotos() {
    const fetcher = window.OnfilmAuth?.apiFetchWithAutoRefresh
            ? window.OnfilmAuth.apiFetchWithAutoRefresh.bind(window.OnfilmAuth)
            : fetch;

    for (const p of photos) {
      if (!p.file || p.s3Key) continue;

      const fd = new FormData();
      fd.append("file", p.file);

      const res = await fetcher("/api/files/person/me/gallery", {
        method: "POST",
        body: fd,
      });

      if (!res.ok) {
        const msg = await res.text().catch(() => "");
        throw new Error(`ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨: ${res.status} ${msg}`);
      }

      const data = await res.json().catch(() => null);
      const key = data?.key ? String(data.key) : null;
      const url = data?.url ? String(data.url) : null;
      if (key) p.s3Key = key;
      if (url) {
        if (p.previewUrl?.startsWith("blob:")) URL.revokeObjectURL(p.previewUrl);
        p.previewUrl = url;
      }
      p.file = null;
    }

    renderGallery();
  }

  async function reorderGallery(publicId) {
    const fetcher = window.OnfilmAuth?.apiFetchWithAutoRefresh
            ? window.OnfilmAuth.apiFetchWithAutoRefresh.bind(window.OnfilmAuth)
            : fetch;

    const keys = photos.map(p => p.s3Key).filter(Boolean);
    const res = await fetcher(`/api/people/${encodeURIComponent(publicId)}/gallery`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ keys }),
    });

    if (!res.ok) {
      const msg = await res.text().catch(() => "");
      throw new Error(`ìˆœì„œ ì €ì¥ ì‹¤íŒ¨: ${res.status} ${msg}`);
    }
  }

  async function deleteGalleryImage(publicId, key) {
    const fetcher = window.OnfilmAuth?.apiFetchWithAutoRefresh
            ? window.OnfilmAuth.apiFetchWithAutoRefresh.bind(window.OnfilmAuth)
            : fetch;

    const res = await fetcher(`/api/people/${encodeURIComponent(publicId)}/gallery?key=${encodeURIComponent(key)}`, {
      method: "DELETE",
    });

    if (!res.ok) {
      const msg = await res.text().catch(() => "");
      throw new Error(`ì‚­ì œ ì‹¤íŒ¨: ${res.status} ${msg}`);
    }
  }
</script>

<script>
  /* =========================================================
     4) "í”„ë¡œí•„ë¡œ ëŒì•„ê°€ê¸°" â†’ ë¬´ì¡°ê±´ /onfilm/{username}
        (ìš”ì²­ëŒ€ë¡œ index.htmlë¡œ ë³´ë‚´ì§€ ì•ŠìŒ)
  ========================================================= */
  document.addEventListener("DOMContentLoaded", () => {
    const link = document.getElementById("backToProfileLink");
    if (!link) return;

    link.addEventListener("click", async (e) => {
      e.preventDefault();

      const authReady = await window.__ONFILM_AUTH_READY_PROMISE__;
      if (!authReady?.ok) {
        const next = encodeURIComponent(location.pathname + location.search);
        location.href = `/login.html?next=${next}`;
        return;
      }

      const uname = await getUsernameSafe();
      if (!uname) {
        // usernameì´ ì—†ìœ¼ë©´ í”„ë¡œí•„ ê²½ë¡œë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìœ¼ë‹ˆ ë¡œê·¸ì¸/ëœë”© ëŒ€ì‹ 
        // ì—¬ê¸°ì„œëŠ” ì•ˆì „í•˜ê²Œ ë¡œê·¸ì¸ìœ¼ë¡œ ë³´ëƒ„(ì„¸ì…˜ okì¸ë° unameì´ ì—†ìœ¼ë©´ ì„¸íŒ…ì´ ëœëœ ìƒíƒœ)
        alert("usernameì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. í”„ë¡œí•„ì—ì„œ usernameì„ ì„¤ì •í•´ ì£¼ì„¸ìš”.");
        return;
      }

      location.href = "/onfilm/" + encodeURIComponent(uname);
    });
  });
</script>

</body>
</html>
