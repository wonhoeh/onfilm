<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>프로필 편집 – OnFilm</title>

    <style>
        :root{
            --bg:#0b0c0f;
            --panel:#12131a;
            --panel-2:#161824;
            --text:#e7e8ee;
            --muted:#9aa0ad;
            --line:rgba(255,255,255,.12);
            --accent:#7c5cff;
            --accent-2:#24d39a;
            --radius-lg:14px;
            --radius-md:10px;
            --shadow:0 10px 40px rgba(0,0,0,.55);
        }

        *{box-sizing:border-box;margin:0;padding:0;}
        body{
            font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
            background:
                    radial-gradient(900px 400px at 80% 0%, rgba(124,92,255,.2), transparent 60%),
                    radial-gradient(700px 350px at 10% 10%, rgba(36,211,154,.15), transparent 60%),
                    var(--bg);
            color:var(--text);
        }

        .page-shell{
            min-height:100vh;
            display:flex;
            flex-direction:column;
            align-items:center;
        }

        header{
            width:100%;
            border-bottom:1px solid var(--line);
            background:rgba(11,12,15,.9);
            backdrop-filter:blur(8px);
        }
        .header-inner{
            width:min(1100px,92vw);
            margin:0 auto;
            padding:14px 0;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
        }
        .header-title{
            font-size:16px;
            font-weight:700;
        }
        .back-link{
            font-size:13px;
            color:var(--muted);
            text-decoration:none;
            display:inline-flex;
            align-items:center;
            gap:4px;
        }
        .back-link:hover{ color:var(--text); }

        main{
            flex:1;
            width:min(1100px,92vw);
            margin:0 auto;
            padding:26px 0 40px;
        }

        .edit-card{
            background:var(--panel);
            border-radius:var(--radius-lg);
            border:1px solid var(--line);
            box-shadow:var(--shadow);
            padding:22px 20px 24px;
            display:grid;
            grid-template-columns:260px minmax(0,1fr);
            gap:24px;
        }

        /* 좌측: 프로필 사진 */
        .photo-section{
            border-right:1px solid var(--line);
            padding-right:20px;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:16px;
        }
        .photo-preview{
            width:210px;
            height:280px;
            border-radius:var(--radius-lg);
            border:1px solid var(--line);
            object-fit:cover;
            background:#050608;
        }
        .photo-preview.drop-hover {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(124,92,255,.7);
        }
        .photo-hint{
            font-size:12px;
            color:var(--muted);
            text-align:center;
            line-height:1.5;
        }
        .pill-btn{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            padding:7px 14px;
            border-radius:999px;
            border:1px solid var(--accent);
            background:rgba(124,92,255,.18);
            color:var(--text);
            font-size:13px;
            cursor:pointer;
            transition:background .15s ease, transform .1s ease;
        }
        .pill-btn:hover{
            background:rgba(124,92,255,.35);
            transform:translateY(-1px);
        }
        .pill-btn input[type="file"]{ display:none; }

        /* 우측: 폼 필드들 */
        .form-section{
            display:flex;
            flex-direction:column;
            gap:18px;
        }

        .field-group{
            display:flex;
            flex-direction:column;
            gap:6px;
            margin-top: 18px;
        }
        .field-label{
            font-size:13px;
            font-weight:600;
        }
        .field-hint{
            font-size:11px;
            color:var(--muted);
        }

        .text-input,
        .select-input{
            width:100%;
            padding:8px 10px;
            border-radius:8px;
            border:1px solid var(--line);
            background:var(--panel-2);
            color:var(--text);
            font-size:14px;
            outline:none;
        }
        .text-input:focus,
        .select-input:focus{
            border-color:var(--accent);
            box-shadow:0 0 0 1px rgba(124,92,255,.35);
        }

        .two-col{
            display:grid;
            grid-template-columns:repeat(2,minmax(0,1fr));
            gap:12px;
        }

        /* SNS 섹션 */
        .sns-row{
            display:grid;
            grid-template-columns:120px minmax(0,1fr) 32px;
            gap:8px;
            align-items:center;
        }
        .sns-remove-btn{
            width:28px;
            height:28px;
            border-radius:50%;
            border:0;
            background:rgba(255,255,255,.06);
            color:var(--muted);
            cursor:pointer;
            font-size:15px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .sns-remove-btn:hover{
            background:rgba(255,80,80,.2);
            color:#ffb3b3;
        }
        .sns-add-btn{
            margin-top:6px;
            font-size:12px;
            padding:5px 10px;
            border-radius:999px;
            border:0;
            background:rgba(255,255,255,.08);
            color:var(--text);
            cursor:pointer;
        }
        .sns-add-btn:hover{ background:rgba(255,255,255,.16); }
        .sns-list{
            display:flex;
            flex-direction:column;
            gap:8px;
            margin-top:4px;
        }

        /* 태그 섹션 */
        .tag-edit-row{
            display:flex;
            gap:6px;
            margin-top:6px;
        }
        .tag-input{ flex:1; }
        .tag-add-btn{
            font-size:12px;
            padding:6px 12px;
            border-radius:999px;
            border:0;
            background:rgba(255,255,255,.08);
            color:var(--text);
            cursor:pointer;
        }
        .tag-add-btn:hover{ background:rgba(255,255,255,.16); }
        .tag-list{
            display:flex;
            flex-wrap:wrap;
            gap:6px;
            margin-top:4px;
        }
        .tag-chip{
            padding:4px 10px;
            border-radius:999px;
            font-size:12px;
            background:rgba(124,92,255,0.18);
            border:1px solid rgba(124,92,255,0.6);
            cursor:pointer;
            cursor: grab;
        }
        .tag-chip:active{ cursor: grabbing; }
        .tag-chip.dragging{ opacity: .5; }
        .tag-chip:hover{ background:rgba(124,92,255,0.32); }

        /* 하단 버튼 */
        .form-actions{
            margin-top:10px;
            display:flex;
            justify-content:flex-end;
            gap:8px;
        }
        .primary-btn,
        .ghost-btn{
            min-width:90px;
            padding:7px 13px;
            border-radius:999px;
            border:0;
            font-size:13px;
            cursor:pointer;
        }
        .primary-btn{
            background:var(--accent);
            color:white;
        }
        .primary-btn:hover{ background:#8a6dff; }
        .ghost-btn{
            background:transparent;
            color:var(--muted);
            border:1px solid var(--line);
        }
        .ghost-btn:hover{
            border-color:var(--accent);
            color:var(--text);
        }

        footer{
            width:100%;
            border-top:1px solid var(--line);
            padding:18px 0 22px;
            margin-top:auto;
            text-align:center;
            font-size:11px;
            color:var(--muted);
        }

        @media (max-width:800px){
            .edit-card{ grid-template-columns:1fr; }
            .photo-section{
                border-right:none;
                border-bottom:1px solid var(--line);
                padding-right:0;
                padding-bottom:18px;
            }
        }
    </style>
</head>

<body>
<div class="page-shell">
    <header>
        <div class="header-inner">
            <a href="#" class="back-link" id="backToProfileLink">← 프로필로 돌아가기</a>
            <div class="header-title">프로필 편집</div>
            <div style="width:70px;"></div>
        </div>
    </header>

    <main>
        <section class="edit-card">
            <!-- 왼쪽: 프로필 사진 -->
            <section class="photo-section">
                <img
                        id="profilePreview"
                        class="photo-preview"
                        src="/videos/profile-placeholder.png"
                        alt="프로필 사진 미리보기" />

                <label class="pill-btn">
                    사진 선택
                    <input type="file" id="profileFileInput" accept="image/*">
                </label>

                <button type="button" class="pill-btn" id="deleteProfileBtn">사진 삭제</button>

                <p class="photo-hint">
                    4:5 비율의 선명한 정면 사진을 권장해요.<br/>
                    (JPG, PNG, 최대 10MB · 클릭 또는 드래그 앤 드롭)
                </p>
            </section>

            <!-- 오른쪽: 입력 폼 -->
            <section class="form-section">
                <form id="editProfileForm">
                    <!-- 이름 -->
                    <div class="field-group">
                        <label for="actorName" class="field-label">이름</label>
                        <input id="actorName" class="text-input" type="text" placeholder="예) 이병헌">
                    </div>

                    <!-- 생년월일 + 출생지 -->
                    <div class="two-col">
                        <div class="field-group">
                            <label class="field-label">출생일</label>

                            <div style="display:flex; gap:6px; align-items:center;">
                                <input id="birthYear" class="text-input" type="text" inputmode="numeric" maxlength="4" placeholder="YYYY" style="max-width:90px;">
                                <span>년</span>

                                <input id="birthMonth" class="text-input" type="text" inputmode="numeric" maxlength="2" placeholder="MM" style="max-width:70px;">
                                <span>월</span>

                                <input id="birthDay" class="text-input" type="text" inputmode="numeric" maxlength="2" placeholder="DD" style="max-width:70px;">
                                <span>일</span>
                            </div>

                            <div class="field-hint">YYYY-MM-DD 형식으로 입력해주세요.</div>

                            <!-- 실제로 서버에 보낼 hidden input -->
                            <input type="hidden" id="birthDate" name="birthDate">
                        </div>

                        <div class="field-group">
                            <label for="birthPlace" class="field-label">출생</label>
                            <input id="birthPlace" class="text-input" type="text" placeholder="예) 서울, 부산, 인천">
                            <div class="field-hint">시 단위로 입력해주세요.</div>
                        </div>
                    </div>

                    <!-- 소개글 -->
                    <div class="field-group">
                        <label for="bioInput" class="field-label">소개글</label>
                        <div class="field-hint">
                            배우로서의 소개, 활동 경력, 분위기를 간단히 적어주세요. (3~4문장 정도 권장)
                        </div>
                        <textarea
                                id="bioInput"
                                class="text-input"
                                rows="4"
                                placeholder="예) 독립영화와 광고를 중심으로 활동 중인 배우입니다. 자연스러운 연기와 밝은 이미지를 강점으로 가지고 있습니다."></textarea>
                    </div>

                    <!-- SNS 여러 개 -->
                    <div class="field-group">
                        <div class="field-label">SNS 링크</div>
                        <div class="field-hint">인스타그램, 유튜브, 틱톡 등 여러 개를 등록할 수 있어요.</div>

                        <div id="snsList" class="sns-list"></div>

                        <button type="button" id="addSnsBtn" class="sns-add-btn">+ SNS 추가</button>
                    </div>

                    <!-- PROFILE TAGS -->
                    <div class="field-group">
                        <div class="field-label">PROFILE TAGS</div>
                        <div class="field-hint">배우의 이미지/강점을 나타내는 키워드를 입력해주세요. (예: 독립영화, 밝은이미지)</div>

                        <div id="tagList" class="tag-list"></div>

                        <div class="tag-edit-row">
                            <input id="tagInput" class="text-input tag-input" type="text" placeholder="자유롭게 입력해주세요.">
                            <button type="button" id="addTagBtn" class="tag-add-btn">추가</button>
                        </div>
                        <div class="field-hint">태그를 클릭하면 삭제됩니다.</div>
                    </div>

                    <!-- 하단 버튼 -->
                    <div class="form-actions">
                        <button type="button" class="ghost-btn" onclick="history.back()">취소</button>
                        <button type="submit" class="primary-btn">저장</button>
                    </div>
                </form>
            </section>
        </section>
    </main>

    <footer>© 2025 OnFilm · Indie Actor & Film Platform</footer>
</div>

<!-- ✅ auth 먼저 -->
<script src="/js/auth.js"></script>
<script src="/js/app.js"></script>

<script>
    /* =========================================================
       0) AUTH READY (토큰/ME 캐시 준비 보장)
    ========================================================= */
    window.__ONFILM_AUTH_READY_PROMISE__ = (async () => {
        try {
            if (!window.OnfilmAuth?.restoreSession) return { ok:false, me:null };
            return await window.OnfilmAuth.restoreSession();
        } catch (e) {
            console.error("restoreSession failed:", e);
            return { ok:false, me:null };
        }
    })();

    /* =========================================================
       1) API HELPER (username -> publicId -> person)
       - 너가 바꾼 엔드포인트: /api/person/{username}
    ========================================================= */
    async function getUsernameSafe() {
        let me = window.OnfilmAuth?.getMe?.() || null;
        if (!me || !me.username) {
            const r = await window.OnfilmAuth?.restoreSession?.().catch(() => null);
            me = r?.me || me;
        }
        const uname = me?.username ? String(me.username).trim() : "";
        return uname || null;
    }

    // ✅ /api/person/{username} -> { publicId: "..." }
    async function fetchPublicIdByUsername(username) {
        const res = await window.OnfilmAuth.apiFetchWithAutoRefresh(
            `/api/person/${encodeURIComponent(username)}`,
            { method:"GET", headers:{ "Accept":"application/json" } }
        );
        if (!res.ok) return null;
        const data = await res.json().catch(() => null);
        return data?.publicId != null ? String(data.publicId) : null;
    }

    // ✅ /api/people/{publicId} -> person
    async function fetchPersonByPublicId(publicId) {
        const res = await window.OnfilmAuth.apiFetchWithAutoRefresh(
            `/api/people/${encodeURIComponent(publicId)}`,
            { method:"GET", headers:{ "Accept":"application/json" } }
        );
        if (!res.ok) return null;
        return await res.json().catch(() => null);
    }

    function personHasAnyContent(p) {
        return !!(p?.name && String(p.name).trim())
            || !!(p?.oneLineIntro && String(p.oneLineIntro).trim())
            || !!(p?.birthDate && String(p.birthDate).trim())
            || !!(p?.birthPlace && String(p.birthPlace).trim())
            || !!(p?.profileImageUrl && String(p.profileImageUrl).trim())
            || (Array.isArray(p?.snsList) && p.snsList.length > 0)
            || (Array.isArray(p?.rawTags) && p.rawTags.length > 0);
    }

    /* =========================================================
       2) ELEMENTS / COMMON UI
    ========================================================= */
    const form = document.getElementById("editProfileForm");
    const saveBtn = form?.querySelector('button[type="submit"]');

    const profileFileInput = document.getElementById("profileFileInput");
    const profilePreview   = document.getElementById("profilePreview");
    const photoSection     = document.querySelector(".photo-section");
    const deleteProfileBtn = document.getElementById("deleteProfileBtn");

    const snsList   = document.getElementById("snsList");
    const addSnsBtn = document.getElementById("addSnsBtn");

    const tagListEl = document.getElementById("tagList");
    const tagInput  = document.getElementById("tagInput");
    const addTagBtn = document.getElementById("addTagBtn");

    const yearInput  = document.getElementById("birthYear");
    const monthInput = document.getElementById("birthMonth");
    const dayInput   = document.getElementById("birthDay");
    const birthDateHidden = document.getElementById("birthDate");

    const PLACEHOLDER_SRC = "/videos/profile-placeholder.png";

    function setSaving(isSaving) {
        if (!saveBtn) return;
        saveBtn.disabled = isSaving;
        saveBtn.textContent = isSaving ? "저장 중..." : "저장";
    }

    function setupAutoMove(current, next) {
        if (!current) return;
        current.addEventListener("input", () => {
            current.value = current.value.replace(/\D/g, "");
            const max = current.getAttribute("maxlength");
            if (max && current.value.length >= parseInt(max, 10) && next) next.focus();
        });
    }
    setupAutoMove(yearInput, monthInput);
    setupAutoMove(monthInput, dayInput);

    /* =========================================================
       3) PHOTO: preview + drag/drop
    ========================================================= */
    function loadProfileImage(file) {
        if (!file) return;

        if (!file.type.startsWith("image/")) {
            alert("이미지 파일만 업로드할 수 있어요. (JPG, PNG 등)");
            return;
        }

        const MAX_SIZE = 10 * 1024 * 1024;
        if (file.size > MAX_SIZE) {
            alert("최대 10MB까지 업로드할 수 있어요.");
            return;
        }

        const reader = new FileReader();
        reader.onload = (ev) => { profilePreview.src = ev.target.result; };
        reader.readAsDataURL(file);

        // input.files 세팅(가능한 브라우저에서)
        try {
            const dt = new DataTransfer();
            dt.items.add(file);
            profileFileInput.files = dt.files;
        } catch (e) {
            console.warn("DataTransfer 미지원 브라우저일 수 있습니다.", e);
        }
    }

    profileFileInput?.addEventListener("change", (e) => {
        const file = e.target.files[0];
        loadProfileImage(file);
    });

    deleteProfileBtn?.addEventListener("click", async () => {
        if (!confirm("프로필 사진을 삭제할까요?")) return;

        const authReady = await window.__ONFILM_AUTH_READY_PROMISE__;
        if (!authReady?.ok) {
            const next = encodeURIComponent(location.pathname + location.search);
            location.href = `/login.html?next=${next}`;
            return;
        }

        const fetcher = window.OnfilmAuth?.apiFetchWithAutoRefresh
                ? window.OnfilmAuth.apiFetchWithAutoRefresh.bind(window.OnfilmAuth)
                : fetch;

        const res = await fetcher("/api/files/person/me/profile", { method: "DELETE" });
        if (!res.ok && res.status !== 404) {
            const msg = await res.text().catch(() => "");
            alert(`삭제 실패: ${res.status} ${msg}`);
            return;
        }

        profilePreview.src = PLACEHOLDER_SRC;
        profilePreview.onerror = null;
        profileFileInput.value = "";
        window.__EXISTING_PROFILE_IMAGE_URL__ = null;
        window.__EXISTING_PROFILE_IMAGE_KEY__ = null;
    });

    if (photoSection) {
        ["dragenter", "dragover"].forEach(evtName => {
            photoSection.addEventListener(evtName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                profilePreview.classList.add("drop-hover");
            });
        });

        ["dragleave", "dragend", "drop"].forEach(evtName => {
            photoSection.addEventListener(evtName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (evtName !== "drop") profilePreview.classList.remove("drop-hover");
            });
        });

        photoSection.addEventListener("drop", (e) => {
            e.preventDefault();
            e.stopPropagation();
            profilePreview.classList.remove("drop-hover");
            const files = e.dataTransfer.files;
            if (!files || files.length === 0) return;
            loadProfileImage(files[0]);
        });
    }

    /* =========================================================
       4) SNS: add/remove rows
    ========================================================= */
    function createSnsRow(initial = {type:"instagram", url:""}) {
        const row = document.createElement("div");
        row.className = "sns-row";

        const select = document.createElement("select");
        select.className = "select-input";
        select.innerHTML = `
    <option value="instagram">Instagram</option>
    <option value="youtube">YouTube</option>
    <option value="tiktok">TikTok</option>
    <option value="etc">기타</option>
  `;
        select.value = initial.type || "instagram";

        const input = document.createElement("input");
        input.className = "text-input";
        input.type = "url";
        input.placeholder = "www.example.com/...";
        input.value = initial.url || "";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "sns-remove-btn";
        removeBtn.textContent = "✕";
        removeBtn.addEventListener("click", () => {
            snsList.removeChild(row);
            if (snsList.children.length === 0) addSnsRow();
        });

        row.appendChild(select);
        row.appendChild(input);
        row.appendChild(removeBtn);
        snsList.appendChild(row);
    }

    function addSnsRow() { createSnsRow({}); }
    addSnsBtn?.addEventListener("click", addSnsRow);

    /* =========================================================
       5) TAGS: add/remove + drag reorder
    ========================================================= */
    let draggedChip = null;
    function handleTagDragStart(e) { draggedChip = e.target; draggedChip.classList.add("dragging"); }
    function handleTagDragEnd() { if (draggedChip) draggedChip.classList.remove("dragging"); draggedChip = null; }

    function addTag(text) {
        const trimmed = String(text || "").trim();
        if (!trimmed) return;

        const label = trimmed.startsWith("#") ? trimmed : `#${trimmed}`;
        const chip = document.createElement("span");
        chip.className = "tag-chip";
        chip.textContent = label;

        chip.draggable = true;
        chip.addEventListener("dragstart", handleTagDragStart);
        chip.addEventListener("dragend", handleTagDragEnd);

        chip.addEventListener("click", () => {
            if (chip.classList.contains("dragging")) return;
            tagListEl.removeChild(chip);
        });

        tagListEl.appendChild(chip);
    }

    addTagBtn?.addEventListener("click", () => {
        addTag(tagInput.value);
        tagInput.value = "";
        tagInput.focus();
    });

    tagInput?.addEventListener("keydown", (e) => {
        if (e.isComposing || e.keyCode === 229) return;
        if (e.key === "Enter") {
            e.preventDefault();
            addTag(tagInput.value);
            tagInput.value = "";
        }
    });

    tagListEl?.addEventListener("dragover", (e) => {
        e.preventDefault();
        if (!draggedChip) return;

        const target = e.target.closest(".tag-chip");
        if (!target || target === draggedChip) return;

        const rect = target.getBoundingClientRect();
        const isAfter = e.clientX > rect.left + rect.width / 2;
        if (isAfter) target.after(draggedChip);
        else target.before(draggedChip);
    });

    /* =========================================================
       6) SERVER DATA MAPPING (prefill)
    ========================================================= */
    function mapServerSnsTypeToUi(typeUpper) {
        const t = (typeUpper || "").toUpperCase();
        if (t === "INSTAGRAM") return "instagram";
        if (t === "YOUTUBE") return "youtube";
        if (t === "TIKTOK") return "tiktok";
        return "etc";
    }

    function normalizeRawTags(rawTags) {
        const arr = Array.isArray(rawTags) ? rawTags : [];
        return arr
            .map(t => (typeof t === "string" ? t : (t?.rawTag || "")))
            .map(s => String(s || "").trim())
            .filter(Boolean);
    }

    function getServerProfileImageField(personObj) {
        // 서버가 key 기반 DTO를 내려주면 그걸 우선 사용
        // (없으면 기존 url 기반으로 동작)
        if (personObj && Object.prototype.hasOwnProperty.call(personObj, "profileImageKey")) return "profileImageKey";
        return "profileImageUrl";
    }

    /* =========================================================
       7) UPLOAD (profile image) + SAVE (POST/PUT)
       - 프로필 이미지 업로드 API 적용:
         POST /{personId}/profile  (보통 @RequestMapping("/files") 아래라서 /files/{personId}/profile)
         응답: { key, url }
    ========================================================= */

    async function ensureEditingPersonId() {
        let pid = window.__EDITING_PERSON_ID__;
        if (pid != null) return pid;

        // publicId로 한번 더 조회해서 id 확보
        const pub = (window.__EDITING_PUBLIC_ID__ || "").toString().trim();
        if (pub) {
            const p = await fetchPersonByPublicId(pub);
            pid = p?.id ?? p?.personId ?? null;
            if (pid != null) {
                window.__EDITING_PERSON_ID__ = pid;
                return pid;
            }
        }

        // 마지막 fallback: username -> publicId -> person
        const uname = await getUsernameSafe();
        if (uname) {
            const publicId = pub || await fetchPublicIdByUsername(uname);
            if (publicId) {
                window.__EDITING_PUBLIC_ID__ = publicId;
                const p2 = await fetchPersonByPublicId(publicId);
                pid = p2?.id ?? p2?.personId ?? null;
                if (pid != null) {
                    window.__EDITING_PERSON_ID__ = pid;
                    return pid;
                }
            }
        }
        return null;
    }

    async function uploadProfileImageIfAny() {
        const file = profileFileInput.files && profileFileInput.files[0];
        if (!file) return null;

        const buildFormData = () => {
            const fd = new FormData();
            fd.append("file", file);
            return fd;
        };

        // ✅ /me 기반 업로드 (personId 필요 없음)
        const candidates = [
            `/api/files/person/me/profile`,
            // 혹시 서버에 /files로 붙어있던 레거시가 있으면 백업:
            `/files/person/me/profile`,
        ];

        let res = null;
        for (const u of candidates) {
            res = await window.OnfilmAuth.apiFetchWithAutoRefresh(u, {
                method: "POST",
                body: buildFormData(),
            });
            if (res.status !== 404) break;
        }

        if (!res || !res.ok) {
            const msg = res ? await res.text().catch(() => "") : "";
            throw new Error(`이미지 업로드 실패: ${res?.status || "ERR"} ${msg}`);
        }

        const data = await res.json().catch(() => null); // { key, url }
        const key = data?.key != null ? String(data.key) : null;
        const url = data?.url != null ? String(data.url) : null;

        // 전역 캐시 업데이트(미리보기/유지용)
        if (key) window.__EXISTING_PROFILE_IMAGE_KEY__ = key;
        if (url) window.__EXISTING_PROFILE_IMAGE_URL__ = url;

        // 업로드 결과 URL로 미리보기 갱신
        if (url) {
            profilePreview.src = url;
            profilePreview.onerror = () => {
                profilePreview.onerror = null;
                profilePreview.src = PLACEHOLDER_SRC;
            };
        }

        return { key, url };
    }


    function buildBirthDateOrThrow() {
        if (!yearInput.value || !monthInput.value || !dayInput.value) {
            throw new Error("출생일을 모두 입력해 주세요.");
        }
        const y = yearInput.value.padStart(4, "0");
        const m = monthInput.value.padStart(2, "0");
        const d = dayInput.value.padStart(2, "0");
        const iso = `${y}-${m}-${d}`;
        birthDateHidden.value = iso;
        return iso;
    }

    function collectSnsPayload() {
        const snsData = [];
        snsList.querySelectorAll(".sns-row").forEach(row => {
            const type = row.querySelector("select").value; // instagram/youtube/tiktok/etc
            const raw  = row.querySelector("input").value.trim();
            if (!raw) return;

            let finalUrl = raw;

            // scheme 없으면 보정
            if (!/^https?:\/\//i.test(raw)) {
                if (type === "instagram") {
                    const handle = raw.replace(/^@/, "");
                    finalUrl = `https://www.instagram.com/${handle}`;
                } else if (type === "youtube") {
                    finalUrl = `https://www.youtube.com/${raw}`;
                } else if (type === "tiktok") {
                    const handle = raw.replace(/^@/, "");
                    finalUrl = `https://www.tiktok.com/@${handle}`;
                } else {
                    finalUrl = `https://${raw}`;
                }
            }

            snsData.push({ type: type.toUpperCase(), url: finalUrl });
        });
        return snsData.length ? snsData : null;
    }

    function collectTagsPayload() {
        const rawTags = [];
        tagListEl.querySelectorAll(".tag-chip").forEach(chip => {
            rawTags.push(chip.textContent.replace(/^#/, "").trim());
        });
        return rawTags.length ? rawTags : null;
    }

    form?.addEventListener("submit", async (e) => {
        e.preventDefault(); // ✅ await보다 먼저!

        const authReady = await window.__ONFILM_AUTH_READY_PROMISE__;
        if (!authReady?.ok) {
            const next = encodeURIComponent(location.pathname + location.search);
            location.href = `/login.html?next=${next}`;
            return;
        }

        if (!window.OnfilmAuth?.apiFetchWithAutoRefresh) {
            alert("auth.js에 apiFetchWithAutoRefresh가 필요해요.");
            return;
        }

        try {
            const name = document.getElementById("actorName").value.trim();
            if (!name) throw new Error("이름을 입력해 주세요.");

            const birthDate = buildBirthDateOrThrow();

            // ✅ 서버가 key 기반인지 url 기반인지에 따라 보존 필드 결정
            const imgField = (window.__SERVER_PROFILE_IMAGE_FIELD__ || "profileImageUrl").toString();
            const existingKey = (window.__EXISTING_PROFILE_IMAGE_KEY__ || "").toString().trim() || null;
            const existingUrl = (window.__EXISTING_PROFILE_IMAGE_URL__ || "").toString().trim() || null;

            const payload = {
                name,
                birthDate,
                birthPlace: document.getElementById("birthPlace").value.trim(),
                oneLineIntro: document.getElementById("bioInput").value.trim(),
                snsList: collectSnsPayload(),
                rawTags: collectTagsPayload(),
            };

            // ✅ 기존 이미지 값 유지(새 업로드가 없을 때 지워지는 사고 방지)
            // - 서버가 key 기반이면 key를, 아니면 url을 보존값으로 포함
            if (imgField === "profileImageKey") {
                if (existingKey) payload.profileImageKey = existingKey;
            } else {
                if (existingUrl) payload.profileImageUrl = existingUrl;
            }

            setSaving(true);

            const hasNewFile = profileFileInput.files && profileFileInput.files.length > 0;

            // 1) 수정/생성 판단: publicId 기준
            let editingPublicId = (window.__EDITING_PUBLIC_ID__ || "").toString().trim();
            const isEdit = !!editingPublicId;

            const url = isEdit
                ? `/api/people/${encodeURIComponent(editingPublicId)}`
                : `/api/people`;
            const method = isEdit ? "PUT" : "POST";

            const res = await window.OnfilmAuth.apiFetchWithAutoRefresh(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            if (!res.ok) {
                const msg = await res.text().catch(() => "");
                throw new Error(`저장 실패: ${res.status}\n${msg}`);
            }

            // 2) 생성(POST)인 경우, 응답에서 publicId / id를 최대한 회수해서 이후 업로드에 사용
            const saved = await res.json().catch(() => null);
            if (!isEdit && saved) {
                if (saved.publicId != null) {
                    window.__EDITING_PUBLIC_ID__ = String(saved.publicId);
                    editingPublicId = window.__EDITING_PUBLIC_ID__;
                }
                const pid = saved.id ?? saved.personId ?? null;
                if (pid != null) window.__EDITING_PERSON_ID__ = pid;
                // 서버가 key 기반 DTO를 준다면 플래그 업데이트
                if (Object.prototype.hasOwnProperty.call(saved, "profileImageKey")) {
                    window.__SERVER_PROFILE_IMAGE_FIELD__ = "profileImageKey";
                }
            }

            // 3) ✅ 프로필 이미지 업로드(선택) — 새 POST API 적용
            //    POST /files/{personId}/profile  -> { key, url }
            if (hasNewFile) {
                const uploaded = await uploadProfileImageIfAny(); // 내부에서 personId 확보 후 업로드
                // 서버가 key 기반이라면, 업로드 결과 key를 보관
                if (uploaded?.key) window.__EXISTING_PROFILE_IMAGE_KEY__ = uploaded.key;
                if (uploaded?.url) window.__EXISTING_PROFILE_IMAGE_URL__ = uploaded.url;
            }

            alert("저장 완료!");

            const uname = await getUsernameSafe();
            if (uname) location.href = `/onfilm/${encodeURIComponent(uname)}`;
            else location.href = `/onfilm`;

        } catch (err) {
            console.error(err);
            alert(err?.message || "저장 중 오류가 발생했습니다.");
        } finally {
            setSaving(false);
        }
    });

    /* =========================================================
       8) PREFILL (저장된 데이터 폼에 채우기)
    ========================================================= */
    async function preloadProfileToEditForm() {
        const authReady = await window.__ONFILM_AUTH_READY_PROMISE__;
        if (!authReady?.ok) return;

        const uname = await getUsernameSafe();
        if (!uname) return;

        // ✅ username -> publicId (변경된 경로 반영)
        const publicId = await fetchPublicIdByUsername(uname);
        if (!publicId) return;

        const p = await fetchPersonByPublicId(publicId);
        if (!p) return;

        window.__EDITING_PUBLIC_ID__ = publicId;

        // ✅ personId (Long) 확보 (업로드 API에 필요)
        window.__EDITING_PERSON_ID__ = p?.id ?? p?.personId ?? null;

        // ✅ 서버가 key 기반인지 url 기반인지 기억
        window.__SERVER_PROFILE_IMAGE_FIELD__ = getServerProfileImageField(p);

        // ✅ 기존 이미지 값 캐시(유지/보존용)
        window.__EXISTING_PROFILE_IMAGE_URL__ = (p?.profileImageUrl || "").toString().trim() || null;
        window.__EXISTING_PROFILE_IMAGE_KEY__ = (p?.profileImageKey || "").toString().trim() || null;

        // 기본 필드
        document.getElementById("actorName").value = p?.name || "";
        document.getElementById("birthPlace").value = p?.birthPlace || "";
        document.getElementById("bioInput").value = p?.oneLineIntro || "";

        // birth yyyy-mm-dd
        const birth = (p?.birthDate || "").trim();
        if (birth) {
            const [yy, mm, dd] = birth.split("-");
            if (yy) yearInput.value = yy;
            if (mm) monthInput.value = mm;
            if (dd) dayInput.value = dd;
            birthDateHidden.value = birth;
        }

        // profile image
        const placeholder = profilePreview.getAttribute("src");
        const real = (p?.profileImageUrl || "").trim();
        if (real) {
            profilePreview.src = real;
            profilePreview.onerror = () => { profilePreview.onerror = null; profilePreview.src = placeholder; };
        } else {
            profilePreview.src = placeholder;
        }

        // SNS: 초기화 후 채움
        snsList.innerHTML = "";
        const sList = Array.isArray(p?.snsList) ? p.snsList : [];
        if (sList.length > 0) {
            sList.forEach(s => createSnsRow({ type: mapServerSnsTypeToUi(s?.type), url: String(s?.url || "").trim() }));
        } else {
            addSnsRow();
        }

        // Tags: 초기화 후 저장값만
        tagListEl.innerHTML = "";
        normalizeRawTags(p?.rawTags).forEach(t => addTag(t));
    }

    /* =========================================================
       9) BACK LINK (프로필로 돌아가기)
       - 프로필 존재+내용 있으면 /onfilm/{username}
       - 아니면 /index.html
    ========================================================= */
    async function handleBackToProfile(e) {
        e.preventDefault();

        try {
            const authReady = await window.__ONFILM_AUTH_READY_PROMISE__;
            if (!authReady?.ok) {
                window.location.href = "/index.html";
                return;
            }

            const uname = await getUsernameSafe();
            if (!uname) {
                window.location.href = "/index.html";
                return;
            }

            const publicId = await fetchPublicIdByUsername(uname);
            if (!publicId) {
                window.location.href = "/index.html";
                return;
            }

            const p = await fetchPersonByPublicId(publicId);
            if (!p || !personHasAnyContent(p)) {
                window.location.href = "/index.html";
                return;
            }

            window.location.href = "/onfilm/" + encodeURIComponent(uname);
        } catch (_) {
            window.location.href = "/index.html";
        }
    }

    /* =========================================================
       10) INIT (DOMContentLoaded)
    ========================================================= */
    document.addEventListener("DOMContentLoaded", async () => {
        const result = await window.__ONFILM_AUTH_READY_PROMISE__;
        if (!result?.ok) {
            const next = encodeURIComponent(location.pathname + location.search);
            location.href = `/login.html?next=${next}`;
            return;
        }

        // SNS 최소 1행 보장(프리필이 덮어씌우면 거기서 다시 세팅됨)
        if (snsList.children.length === 0) addSnsRow();

        await preloadProfileToEditForm();

        // back link
        const link = document.getElementById("backToProfileLink");
        link?.addEventListener("click", handleBackToProfile);
    });

    // 전체 드롭 기본 동작 방지(페이지 이동 방지)
    window.addEventListener("dragover", (e) => e.preventDefault());
    window.addEventListener("drop", (e) => e.preventDefault());
</script>

</body>
</html>
