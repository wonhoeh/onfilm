<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>í”„ë¡œí•„ í¸ì§‘ â€“ OnFilm</title>

    <style>
        :root{
            --bg:#0b0c0f;
            --panel:#12131a;
            --panel-2:#161824;
            --text:#e7e8ee;
            --muted:#9aa0ad;
            --line:rgba(255,255,255,.12);
            --accent:#7c5cff;
            --accent-2:#24d39a;
            --radius-lg:14px;
            --radius-md:10px;
            --shadow:0 10px 40px rgba(0,0,0,.55);
        }

        *{box-sizing:border-box;margin:0;padding:0;}
        body{
            font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
            background:
                    radial-gradient(900px 400px at 80% 0%, rgba(124,92,255,.2), transparent 60%),
                    radial-gradient(700px 350px at 10% 10%, rgba(36,211,154,.15), transparent 60%),
                    var(--bg);
            color:var(--text);
        }

        .page-shell{
            min-height:100vh;
            display:flex;
            flex-direction:column;
            align-items:center;
        }

        header{
            width:100%;
            border-bottom:1px solid var(--line);
            background:rgba(11,12,15,.9);
            backdrop-filter:blur(8px);
        }
        .header-inner{
            width:min(1100px,92vw);
            margin:0 auto;
            padding:14px 0;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
        }
        .header-title{
            font-size:16px;
            font-weight:700;
        }
        .back-link{
            font-size:13px;
            color:var(--muted);
            text-decoration:none;
            display:inline-flex;
            align-items:center;
            gap:4px;
        }
        .back-link:hover{
            color:var(--text);
        }

        main{
            flex:1;
            width:min(1100px,92vw);
            margin:0 auto;
            padding:26px 0 40px;
        }

        .edit-card{
            background:var(--panel);
            border-radius:var(--radius-lg);
            border:1px solid var(--line);
            box-shadow:var(--shadow);
            padding:22px 20px 24px;
            display:grid;
            grid-template-columns:260px minmax(0,1fr);
            gap:24px;
        }

        /* ì¢Œì¸¡: í”„ë¡œí•„ ì‚¬ì§„ */
        .photo-section{
            border-right:1px solid var(--line);
            padding-right:20px;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:16px;
        }
        /* ë“œë˜ê·¸ë¡œ íŒŒì¼ì´ ì˜¬ë¼ì™”ì„ ë•Œ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .photo-preview.drop-hover {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(124,92,255,.7);
        }
        .photo-preview{
            width:210px;
            height:280px;
            border-radius:var(--radius-lg);
            border:1px solid var(--line);
            object-fit:cover;
            background:#050608;
        }
        .photo-hint{
            font-size:12px;
            color:var(--muted);
            text-align:center;
            line-height:1.5;
        }
        .pill-btn{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            padding:7px 14px;
            border-radius:999px;
            border:1px solid var(--accent);
            background:rgba(124,92,255,.18);
            color:var(--text);
            font-size:13px;
            cursor:pointer;
            transition:background .15s ease, transform .1s ease;
        }
        .pill-btn:hover{
            background:rgba(124,92,255,.35);
            transform:translateY(-1px);
        }
        .pill-btn input[type="file"]{
            display:none;
        }

        /* ìš°ì¸¡: í¼ í•„ë“œë“¤ */
        .form-section{
            display:flex;
            flex-direction:column;
            gap:18px;
        }

        .field-group{
            display:flex;
            flex-direction:column;
            gap:6px;
            margin-top: 18px;
        }
        .field-label{
            font-size:13px;
            font-weight:600;
        }
        .field-hint{
            font-size:11px;
            color:var(--muted);
        }

        .text-input,
        .select-input{
            width:100%;
            padding:8px 10px;
            border-radius:8px;
            border:1px solid var(--line);
            background:var(--panel-2);
            color:var(--text);
            font-size:14px;
            outline:none;
        }
        .text-input:focus,
        .select-input:focus{
            border-color:var(--accent);
            box-shadow:0 0 0 1px rgba(124,92,255,.35);
        }

        /* ì¶œìƒë…„ë„ date ì¸í’‹ ë‹¬ë ¥ ì•„ì´ì½˜ì„ ë°ê²Œ(í°ìƒ‰ ëŠë‚Œ) ë³´ì´ê²Œ */
        #birthDate::-webkit-calendar-picker-indicator {
            filter: invert(1);      /* ì–´ë‘ìš´ ë°°ê²½ì—ì„œ ì•„ì´ì½˜ì„ ë°ê²Œ */
            cursor: pointer;
        }

        .two-col{
            display:grid;
            grid-template-columns:repeat(2,minmax(0,1fr));
            gap:12px;
            /*margin-top:12px;*/
        }

        /* SNS ì„¹ì…˜ */
        .sns-row{
            display:grid;
            grid-template-columns:120px minmax(0,1fr) 32px;
            gap:8px;
            align-items:center;
        }
        .sns-remove-btn{
            width:28px;
            height:28px;
            border-radius:50%;
            border:0;
            background:rgba(255,255,255,.06);
            color:var(--muted);
            cursor:pointer;
            font-size:15px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .sns-remove-btn:hover{
            background:rgba(255,80,80,.2);
            color:#ffb3b3;
        }
        .sns-add-btn{
            margin-top:6px;
            font-size:12px;
            padding:5px 10px;
            border-radius:999px;
            border:0;
            background:rgba(255,255,255,.08);
            color:var(--text);
            cursor:pointer;
        }
        .sns-add-btn:hover{
            background:rgba(255,255,255,.16);
        }
        .sns-list{
            display:flex;
            flex-direction:column;
            gap:8px;
            margin-top:4px;
        }

        /* íƒœê·¸ ì„¹ì…˜ */
        .tag-edit-row{
            display:flex;
            gap:6px;
            margin-top:6px;
        }
        .tag-input{
            flex:1;
        }
        .tag-add-btn{
            font-size:12px;
            padding:6px 12px;
            border-radius:999px;
            border:0;
            background:rgba(255,255,255,.08);
            color:var(--text);
            cursor:pointer;
        }
        .tag-add-btn:hover{
            background:rgba(255,255,255,.16);
        }
        .tag-list{
            display:flex;
            flex-wrap:wrap;
            gap:6px;
            margin-top:4px;
        }
        .tag-chip{
            padding:4px 10px;
            border-radius:999px;
            font-size:12px;
            background:rgba(124,92,255,0.18);
            border:1px solid rgba(124,92,255,0.6);
            cursor:pointer;

            /* â†“ ì¶”ê°€ */
            cursor: grab;
        }
        .tag-chip:active{
            cursor: grabbing;
        }

        /* ë“œë˜ê·¸ ì¤‘ ì‹œê° íš¨ê³¼ */
        .tag-chip.dragging{
            opacity: .5;
        }
        .tag-chip:hover{
            background:rgba(124,92,255,0.32);
        }

        /* í•˜ë‹¨ ë²„íŠ¼ */
        .form-actions{
            margin-top:10px;
            display:flex;
            justify-content:flex-end;
            gap:8px;
        }
        .primary-btn,
        .ghost-btn{
            min-width:90px;
            padding:7px 13px;
            border-radius:999px;
            border:0;
            font-size:13px;
            cursor:pointer;
        }
        .primary-btn{
            background:var(--accent);
            color:white;
        }
        .primary-btn:hover{
            background:#8a6dff;
        }
        .ghost-btn{
            background:transparent;
            color:var(--muted);
            border:1px solid var(--line);
        }
        .ghost-btn:hover{
            border-color:var(--accent);
            color:var(--text);
        }

        footer{
            width:100%;
            border-top:1px solid var(--line);
            padding:18px 0 22px;
            margin-top:auto;
            text-align:center;
            font-size:11px;
            color:var(--muted);
        }

        @media (max-width:800px){
            .edit-card{
                grid-template-columns:1fr;
            }
            .photo-section{
                border-right:none;
                border-bottom:1px solid var(--line);
                padding-right:0;
                padding-bottom:18px;
            }
        }
    </style>
</head>
<body>
<div class="page-shell">
    <header>
        <div class="header-inner">
            <a href="actor-detail-temp.html" class="back-link">
                â† í”„ë¡œí•„ë¡œ ëŒì•„ê°€ê¸°
            </a>
            <div class="header-title">í”„ë¡œí•„ í¸ì§‘</div>
            <div style="width:70px;"></div>
        </div>
    </header>

    <main>
        <section class="edit-card">
            <!-- ì™¼ìª½: í”„ë¡œí•„ ì‚¬ì§„ -->
            <section class="photo-section">
                <img
                        id="profilePreview"
                        class="photo-preview"
                        src="videos/profile-placeholder.png"
                        alt="í”„ë¡œí•„ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°" />

                <label class="pill-btn">
                    ì‚¬ì§„ ì„ íƒ
                    <input type="file" id="profileFileInput" accept="image/*">
                </label>

                <p class="photo-hint">
                    4:5 ë¹„ìœ¨ì˜ ì„ ëª…í•œ ì •ë©´ ì‚¬ì§„ì„ ê¶Œì¥í•´ìš”.<br/>
                    (JPG, PNG, ìµœëŒ€ 10MB Â· í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­)
                </p>
            </section>

            <!-- ì˜¤ë¥¸ìª½: ì…ë ¥ í¼ -->
            <section class="form-section">
                <form id="editProfileForm">
                    <!-- ì´ë¦„ -->
                    <div class="field-group">
                        <label for="actorName" class="field-label">ì´ë¦„</label>
                        <input id="actorName" class="text-input" type="text" placeholder="ì˜ˆ) ì´ë³‘í—Œ">
                    </div>

                    <!-- ìƒë…„ì›”ì¼ + ì¶œìƒì§€ -->
                    <div class="two-col">
                        <div class="field-group">
                            <label class="field-label">ì¶œìƒì¼</label>

                            <div style="display:flex; gap:6px; align-items:center;">
                                <input
                                        id="birthYear"
                                        class="text-input"
                                        type="text"
                                        inputmode="numeric"
                                        maxlength="4"
                                        placeholder="YYYY"
                                        style="max-width:90px;"
                                >
                                <span>ë…„</span>

                                <input
                                        id="birthMonth"
                                        class="text-input"
                                        type="text"
                                        inputmode="numeric"
                                        maxlength="2"
                                        placeholder="MM"
                                        style="max-width:70px;"
                                >
                                <span>ì›”</span>

                                <input
                                        id="birthDay"
                                        class="text-input"
                                        type="text"
                                        inputmode="numeric"
                                        maxlength="2"
                                        placeholder="DD"
                                        style="max-width:70px;"
                                >
                                <span>ì¼</span>
                            </div>

                            <div class="field-hint">YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>

                            <!-- ì‹¤ì œë¡œ ì„œë²„ì— ë³´ë‚¼ hidden input -->
                            <input type="hidden" id="birthDate" name="birthDate">
                        </div>

                        <div class="field-group">
                            <label for="birthPlace" class="field-label">ì¶œìƒ</label>
                            <input
                                    id="birthPlace"
                                    class="text-input"
                                    type="text"
                                    placeholder="ì˜ˆ) ì„œìš¸, ë¶€ì‚°, ì¸ì²œ"
                            >
                            <div class="field-hint">ì‹œ ë‹¨ìœ„ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                        </div>
                    </div>

                    <!-- ğŸ‘‡ğŸ‘‡ ì—¬ê¸°ë¶€í„° ìƒˆë¡œ ì¶”ê°€í•œ ì†Œê°œê¸€ ì˜ì—­ -->
                    <div class="field-group">
                        <label for="bioInput" class="field-label">ì†Œê°œê¸€</label>
                        <div class="field-hint">
                            ë°°ìš°ë¡œì„œì˜ ì†Œê°œ, í™œë™ ê²½ë ¥, ë¶„ìœ„ê¸°ë¥¼ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”. (3~4ë¬¸ì¥ ì •ë„ ê¶Œì¥)
                        </div>
                        <textarea
                                id="bioInput"
                                class="text-input"
                                rows="4"
                                placeholder="ì˜ˆ) ë…ë¦½ì˜í™”ì™€ ê´‘ê³ ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ í™œë™ ì¤‘ì¸ ë°°ìš°ì…ë‹ˆë‹¤. ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê¸°ì™€ ë°ì€ ì´ë¯¸ì§€ë¥¼ ê°•ì ìœ¼ë¡œ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤."></textarea>
                    </div>
                    <!-- ğŸ‘†ğŸ‘† ì—¬ê¸°ê¹Œì§€ -->

                    <!-- SNS ì—¬ëŸ¬ ê°œ -->
                    <div class="field-group">
                        <div class="field-label">SNS ë§í¬</div>
                        <div class="field-hint">
                            ì¸ìŠ¤íƒ€ê·¸ë¨, ìœ íŠœë¸Œ, í‹±í†¡ ë“± ì—¬ëŸ¬ ê°œë¥¼ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”.
                        </div>

                        <div id="snsList" class="sns-list">
                            <!-- JSë¡œ ê¸°ë³¸ 1ê°œ í–‰ ì¶”ê°€ -->
                        </div>

                        <button type="button" id="addSnsBtn" class="sns-add-btn">
                            + SNS ì¶”ê°€
                        </button>
                    </div>

                    <!-- PROFILE TAGS -->
                    <div class="field-group">
                        <div class="field-label">PROFILE TAGS</div>
                        <div class="field-hint">
                            ë°°ìš°ì˜ ì´ë¯¸ì§€/ê°•ì ì„ ë‚˜íƒ€ë‚´ëŠ” í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: ë…ë¦½ì˜í™”, ë°ì€ì´ë¯¸ì§€)
                        </div>

                        <div id="tagList" class="tag-list">
                            <!-- íƒœê·¸ chipë“¤ -->
                        </div>

                        <div class="tag-edit-row">
                            <input
                                    id="tagInput"
                                    class="text-input tag-input"
                                    type="text"
                                    placeholder="ììœ ë¡­ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”."
                            >
                            <button type="button" id="addTagBtn" class="tag-add-btn">ì¶”ê°€</button>
                        </div>
                        <div class="field-hint">íƒœê·¸ë¥¼ í´ë¦­í•˜ë©´ ì‚­ì œë©ë‹ˆë‹¤.</div>
                    </div>

                    <!-- í•˜ë‹¨ ë²„íŠ¼ -->
                    <div class="form-actions">
                        <button type="button" class="ghost-btn" onclick="history.back()">ì·¨ì†Œ</button>
                        <button type="submit" class="primary-btn">ì €ì¥</button>
                    </div>
                </form>
            </section>
        </section>
    </main>

    <footer>
        Â© 2025 OnFilm Â· Indie Actor & Film Platform
    </footer>
</div>

<!-- âœ… OnfilmAuth ë¨¼ì € ë¡œë“œ -->
<script src="/js/auth.js"></script>
<script src="/js/app.js"></script>

<script>
    // âœ… auth ì¤€ë¹„(restoreSession) ì™„ë£Œë¥¼ ë³´ì¥í•˜ëŠ” ì „ì—­ Promise
    window.__ONFILM_AUTH_READY_PROMISE__ = (async () => {
        try {
            if (!window.OnfilmAuth?.restoreSession) return { ok: false, me: null };
            return await window.OnfilmAuth.restoreSession(); // accessToken + meCache ì±„ì›€
        } catch (e) {
            console.error("restoreSession failed:", e);
            return { ok: false, me: null };
        }
    })();

    /* ===== í”„ë¡œí•„ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° + ë“œë˜ê·¸ ì•¤ ë“œë¡­ ===== */
    const profileFileInput = document.getElementById("profileFileInput");
    const profilePreview   = document.getElementById("profilePreview");
    const photoSection     = document.querySelector(".photo-section");

    function loadProfileImage(file) {
        if (!file) return;

        if (!file.type.startsWith("image/")) {
            alert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆì–´ìš”. (JPG, PNG ë“±)");
            return;
        }

        const MAX_SIZE = 10 * 1024 * 1024;
        if (file.size > MAX_SIZE) {
            alert("ìµœëŒ€ 10MBê¹Œì§€ ì—…ë¡œë“œí•  ìˆ˜ ìˆì–´ìš”.");
            return;
        }

        const reader = new FileReader();
        reader.onload = (ev) => {
            profilePreview.src = ev.target.result;
        };
        reader.readAsDataURL(file);

        try {
            const dt = new DataTransfer();
            dt.items.add(file);
            profileFileInput.files = dt.files;
        } catch (e) {
            console.warn("DataTransfer ë¯¸ì§€ì› ë¸Œë¼ìš°ì €ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", e);
        }
    }

    profileFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        loadProfileImage(file);
    });

    if (photoSection) {
        ["dragenter", "dragover"].forEach(evtName => {
            photoSection.addEventListener(evtName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                profilePreview.classList.add("drop-hover");
            });
        });

        ["dragleave", "dragend", "drop"].forEach(evtName => {
            photoSection.addEventListener(evtName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (evtName !== "drop") {
                    profilePreview.classList.remove("drop-hover");
                }
            });
        });

        photoSection.addEventListener("drop", (e) => {
            e.preventDefault();
            e.stopPropagation();
            profilePreview.classList.remove("drop-hover");

            const files = e.dataTransfer.files;
            if (!files || files.length === 0) return;

            loadProfileImage(files[0]);
        });
    }

    /* ===== SNS í–‰ ì¶”ê°€/ì‚­ì œ ===== */
    const snsList   = document.getElementById("snsList");
    const addSnsBtn = document.getElementById("addSnsBtn");

    function createSnsRow(initial = {type:"instagram", url:""}) {
        const row = document.createElement("div");
        row.className = "sns-row";

        const select = document.createElement("select");
        select.className = "select-input";
        select.innerHTML = `
      <option value="instagram">Instagram</option>
      <option value="youtube">YouTube</option>
      <option value="tiktok">TikTok</option>
      <option value="etc">ê¸°íƒ€</option>
    `;
        select.value = initial.type || "instagram";

        const input = document.createElement("input");
        input.className = "text-input";
        input.type = "url";
        input.placeholder = "www.example.com/...";
        input.value = initial.url || "";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "sns-remove-btn";
        removeBtn.textContent = "âœ•";
        removeBtn.addEventListener("click", () => {
            snsList.removeChild(row);
            if (snsList.children.length === 0) addSnsRow();
        });

        row.appendChild(select);
        row.appendChild(input);
        row.appendChild(removeBtn);
        snsList.appendChild(row);
    }

    function addSnsRow() { createSnsRow({}); }
    addSnsBtn.addEventListener("click", addSnsRow);
    addSnsRow();

    /* ===== TAGS ===== */
    const tagListEl = document.getElementById("tagList");
    const tagInput  = document.getElementById("tagInput");
    const addTagBtn = document.getElementById("addTagBtn");

    let draggedChip = null;
    function handleTagDragStart(e) { draggedChip = e.target; draggedChip.classList.add("dragging"); }
    function handleTagDragEnd() { if (draggedChip) draggedChip.classList.remove("dragging"); draggedChip = null; }

    function addTag(text) {
        const trimmed = text.trim();
        if (!trimmed) return;

        const label = trimmed.startsWith("#") ? trimmed : `#${trimmed}`;
        const chip = document.createElement("span");
        chip.className = "tag-chip";
        chip.textContent = label;

        chip.draggable = true;
        chip.addEventListener("dragstart", handleTagDragStart);
        chip.addEventListener("dragend", handleTagDragEnd);

        chip.addEventListener("click", () => {
            if (chip.classList.contains("dragging")) return;
            tagListEl.removeChild(chip);
        });

        tagListEl.appendChild(chip);
    }

    addTagBtn.addEventListener("click", () => {
        addTag(tagInput.value);
        tagInput.value = "";
        tagInput.focus();
    });

    tagInput.addEventListener("keydown", (e) => {
        if (e.isComposing || e.keyCode === 229) return;
        if (e.key === "Enter") {
            e.preventDefault();
            addTag(tagInput.value);
            tagInput.value = "";
        }
    });

    tagListEl.addEventListener("dragover", (e) => {
        e.preventDefault();
        if (!draggedChip) return;

        const target = e.target.closest(".tag-chip");
        if (!target || target === draggedChip) return;

        const rect = target.getBoundingClientRect();
        const isAfter = e.clientX > rect.left + rect.width / 2;
        if (isAfter) target.after(draggedChip);
        else target.before(draggedChip);
    });

    ["#ì•„ì—­", "#ë°ì€ ì´ë¯¸ì§€", "#ê´‘ê³  ì¹œí™”ì "].forEach(addTag);

    /* ===== ì¶œìƒì¼ hidden ê°’ ì±„ìš°ê¸° ===== */
    const yearInput  = document.getElementById("birthYear");
    const monthInput = document.getElementById("birthMonth");
    const dayInput   = document.getElementById("birthDay");
    const birthDateHidden = document.getElementById("birthDate");

    function setupAutoMove(current, next) {
        if (!current) return;
        current.addEventListener("input", () => {
            current.value = current.value.replace(/\D/g, "");
            const max = current.getAttribute("maxlength");
            if (max && current.value.length >= parseInt(max, 10) && next) next.focus();
        });
    }
    setupAutoMove(yearInput, monthInput);
    setupAutoMove(monthInput, dayInput);

    /* ===============================
       âœ… ì—¬ê¸°ë¶€í„°: ì—…ë¡œë“œ â†’ URL â†’ /persons
    =============================== */

    const form = document.getElementById("editProfileForm");
    const saveBtn = form.querySelector('button[type="submit"]');
    const PLACEHOLDER_SRC = "videos/profile-placeholder.png";

    function setSaving(isSaving) {
        if (!saveBtn) return;
        saveBtn.disabled = isSaving;
        saveBtn.textContent = isSaving ? "ì €ì¥ ì¤‘..." : "ì €ì¥";
    }

    async function uploadProfileImageIfAny() {
        const file = profileFileInput.files && profileFileInput.files[0];
        if (!file) return null;

        const fd = new FormData();
        fd.append("file", file);

        const res = await window.OnfilmAuth.apiFetchWithAutoRefresh("/files", {
            method: "POST",
            body: fd,
        });

        if (!res.ok) {
            const msg = await res.text().catch(() => "");
            throw new Error(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${res.status} ${msg}`);
        }

        const data = await res.json(); // { url: "/uploads/xxx.jpg" }
        return data && data.url ? data.url : null;
    }

    form.addEventListener("submit", async (e) => {
        // âœ… authê°€ ì‹¤ì œë¡œ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼ (í† í°/ME ìºì‹œ í™•ì‹¤íˆ ì„¸íŒ…)
        const authReady = await window.__ONFILM_AUTH_READY_PROMISE__;
        if (!authReady?.ok) {
            const next = encodeURIComponent(location.pathname + location.search);
            location.href = `/login.html?next=${next}`;
            return;
        }

        e.preventDefault();
        if (!window.OnfilmAuth) {
            alert("auth.js ë¡œë“œ/ì‹¤í–‰ì´ ì•ˆ ëì–´ìš”. (window.OnfilmAuth ì—†ìŒ)");
            return;
        }
        if (!window.OnfilmAuth.apiFetchWithAutoRefresh) {
            alert("auth.jsì— apiFetchWithAutoRefreshê°€ ì•„ì§ ì—†ì–´ìš”. auth.js ìˆ˜ì • í•„ìš”");
            return;
        }

        // ì¶œìƒì¼ ì¡°í•©
        if (!yearInput.value || !monthInput.value || !dayInput.value) {
            alert("ì¶œìƒì¼ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }
        const y = yearInput.value.padStart(4, "0");
        const m = monthInput.value.padStart(2, "0");
        const d = dayInput.value.padStart(2, "0");
        birthDateHidden.value = `${y}-${m}-${d}`;

        // í•„ìˆ˜ê°’ ê²€ì¦
        const name = document.getElementById("actorName").value.trim();
        if (!name) {
            alert("ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }

        // SNS ìˆ˜ì§‘ (ì„œë²„ enumì— ë§ê²Œ ëŒ€ë¬¸ì)
        const snsData = [];
        snsList.querySelectorAll(".sns-row").forEach(row => {
            const type = row.querySelector("select").value; // instagram/youtube/tiktok/etc
            const raw  = row.querySelector("input").value.trim();
            if (!raw) return;

            let finalUrl = raw;
            if (!/^https?:\/\//i.test(raw)) {
                if (type === "instagram") {
                    const handle = raw.replace(/^@/, "");
                    finalUrl = `https://www.instagram.com/${handle}`;
                } else if (type === "youtube") {
                    finalUrl = `https://www.youtube.com/${raw}`;
                } else if (type === "tiktok") {
                    const handle = raw.replace(/^@/, "");
                    finalUrl = `https://www.tiktok.com/@${handle}`;
                } else {
                    finalUrl = `https://${raw}`;
                }
            }

            snsData.push({ type: type.toUpperCase(), url: finalUrl });
        });

        // rawTags ìˆ˜ì§‘ (ì„œë²„ëŠ” List<String>)
        const rawTags = [];
        tagListEl.querySelectorAll(".tag-chip").forEach(chip => {
            rawTags.push(chip.textContent.replace(/^#/, "").trim());
        });

        setSaving(true);

        try {
            // âœ… 1) ì´ë¯¸ì§€ ì—…ë¡œë“œ(ì„ íƒ) â†’ URL í™•ë³´
            // placeholder ìƒíƒœê±°ë‚˜ íŒŒì¼ ì—†ìœ¼ë©´ nullë¡œ ë‘”ë‹¤
            let profileImageUrl = null;
            const hasNewFile = profileFileInput.files && profileFileInput.files.length > 0;
            const isPlaceholder = (profilePreview.getAttribute("src") || "").includes(PLACEHOLDER_SRC);

            if (hasNewFile && !isPlaceholder) {
                profileImageUrl = await uploadProfileImageIfAny(); // "/uploads/xxx.jpg"
            } else if (hasNewFile) {
                // placeholderì§€ë§Œ íŒŒì¼ì´ ìˆìœ¼ë©´ ì—…ë¡œë“œëŠ” í•œë‹¤ (ë“œë¡­/ì„ íƒ í›„ ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨ ì¼€ì´ìŠ¤ ë°©ì–´)
                profileImageUrl = await uploadProfileImageIfAny();
            }

            // âœ… 2) CreatePersonRequestì— URL ë„£ê³  /persons í˜¸ì¶œ
            const payload = {
                name,
                birthDate: birthDateHidden.value,
                birthPlace: document.getElementById("birthPlace").value.trim(),
                oneLineIntro: document.getElementById("bioInput").value.trim(),
                profileImageUrl,                    // âœ… ì—…ë¡œë“œ ê²°ê³¼ URL
                snsList: snsData.length ? snsData : null,
                rawTags: rawTags.length ? rawTags : null,
            };

            const res = await window.OnfilmAuth.apiFetchWithAutoRefresh("/persons", {
                method: "POST",
                body: JSON.stringify(payload),
            });

            if (!res.ok) {
                const msg = await res.text().catch(() => "");
                alert(`ì €ì¥ ì‹¤íŒ¨: ${res.status}\n${msg}`);
                return;
            }

            const personIdText = await res.text();
            const personId = Number(personIdText);

            alert("ì €ì¥ ì™„ë£Œ!");

            // âœ… usernameì´ ìºì‹œì— ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ í•œë²ˆ ë” ë³µêµ¬ ì‹œë„í•´ì„œ í™•ë³´
            let me = window.OnfilmAuth.getMe && window.OnfilmAuth.getMe();
            if (!me || !me.username) {
                const r = await window.OnfilmAuth.restoreSession().catch(() => null);
                me = (r && r.me) ? r.me : me;
            }

            const uname = me && me.username ? String(me.username).trim() : "";

            // âœ… ëª©í‘œ: ê³µê°œ í˜ì´ì§€(/onfilm/{username})ë¡œ ì´ë™. username ì—†ìœ¼ë©´ /onfilm(ê³µê°œ)ë¡œë§Œ ì´ë™
            if (uname) {
                location.href = `/onfilm/${encodeURIComponent(uname)}`;
            } else {
                location.href = `/onfilm`;
            }

        } catch (err) {
            console.error(err);
            alert(err?.message || "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            setSaving(false);
        }
    });

    window.addEventListener("dragover", (e) => e.preventDefault());
    window.addEventListener("drop", (e) => e.preventDefault());
</script>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const result = await window.__ONFILM_AUTH_READY_PROMISE__;
        if (!result?.ok) {
            const next = encodeURIComponent(location.pathname + location.search);
            location.href = `/login.html?next=${next}`;
        }
    });
</script>

</body>
</html>