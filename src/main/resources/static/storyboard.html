<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OnFilm – 스토리보드 프로젝트</title>
    <style>
        :root{
            --bg:#0b0c0f;
            --panel:#12131a;
            --text:#e7e8ee;
            --muted:#9aa0ad;
            --line:rgba(255,255,255,.10);
            --accent:#7c5cff;
            --accent-2:#24d39a;
            --link-blue:#5aa7ff;
            --icon-ring: rgba(255,255,255,.75);
        }
        *{box-sizing:border-box;margin:0;padding:0;}
        body{
            font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
            background:
                    radial-gradient(900px 400px at 80% 0%, rgba(124,92,255,.18), transparent 60%),
                    radial-gradient(700px 350px at 10% 10%, rgba(36,211,154,.14), transparent 60%),
                    var(--bg);
            color:var(--text);
            min-height:100vh;
        }
        .page-shell{
            min-height:100vh;
            display:flex;
            flex-direction:column;
        }
        header.top-header{
            width:100%;
            border-bottom:1px solid var(--line);
            padding:16px 0;
        }
        .header-inner{
            width:min(1180px, 92vw);
            margin:0 auto;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:16px;
        }
        .header-right{
            display:flex;
            align-items:center;
            gap:10px;
        }
        .profile-menu{ position:relative; }
        .profile-avatar-btn{
            width:32px;
            height:32px;
            border-radius:999px;
            border:1px solid var(--line);
            padding:0;
            background:rgba(255,255,255,0.04);
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            overflow:hidden;
            transition:transform .12s ease,border-color .12s ease,box-shadow .12s ease;
        }
        .profile-avatar-btn:hover{
            transform:translateY(-1px);
            border-color:var(--accent);
            box-shadow:0 6px 18px rgba(0,0,0,.6);
        }
        .profile-avatar-btn img{
            width:100%;
            height:100%;
            object-fit:cover;
        }
        .profile-avatar-initial{
            font-size:13px;
            font-weight:700;
            color:var(--text);
        }
        .profile-dropdown{
            position:absolute;
            top:120%;
            right:0;
            min-width:210px;
            background:var(--panel);
            border-radius:12px;
            border:1px solid var(--line);
            box-shadow:0 14px 40px rgba(0,0,0,.9);
            padding:6px 0;
            opacity:0;
            pointer-events:none;
            transform:translateY(-6px);
            transition:opacity .16s ease, transform .16s ease;
            z-index:9999;
        }
        .profile-dropdown.open{
            opacity:1;
            pointer-events:auto;
            transform:translateY(0);
        }
        .profile-group-title{
            padding:8px 12px 6px;
            font-size:11px;
            color:var(--muted);
            letter-spacing:.12em;
            text-transform:uppercase;
        }
        .profile-divider{
            height:1px;
            margin:6px 0;
            background:rgba(255,255,255,.08);
        }
        .profile-item{
            width:100%;
            padding:8px 12px;
            text-align:left;
            background:transparent;
            border:none;
            color:var(--text);
            font-size:13px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
        }
        .profile-item span{
            font-size:11px;
            color:var(--muted);
        }
        .profile-item:hover{
            background:rgba(255,255,255,0.06);
        }
        .login-btn{
            border:1px solid var(--line);
            background:rgba(255,255,255,.04);
            color:var(--text);
            padding:6px 12px;
            border-radius:999px;
            cursor:pointer;
            font-size:12px;
        }
        .back-link{
            color:var(--muted);
            text-decoration:none;
            font-size:13px;
        }
        .back-link:hover{ color:var(--text); }
        .header-title{
            font-size:15px;
            font-weight:600;
            letter-spacing:-.2px;
        }
        .wrap{
            width:min(1180px, 92vw);
            margin: 28px auto 70px;
        }
        .toolbar{
            display:flex;
            align-items:center;
            justify-content:flex-end;
            gap:12px;
            margin-bottom:18px;
        }
        .primary-btn{
            width:44px;
            height:44px;
            border:0;
            background:linear-gradient(135deg, var(--accent), var(--accent-2));
            color:#fff;
            border-radius:50%;
            font-weight:700;
            font-size:22px;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 8px 24px rgba(36,211,154,.25);
        }
        .grid{
            display:grid;
            grid-template-columns:repeat(3, minmax(0, 1fr));
            gap:20px;
            min-height: calc(100vh - 240px);
            justify-items:center;
        }
        @media (max-width: 980px){
            .grid{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
        }
        @media (max-width: 640px){
            .grid{ grid-template-columns:1fr; }
        }
        .grid.empty-mode{
            display:flex;
            justify-content:center;
            align-items:center;
        }
        .grid.empty-mode .empty-cta{
            max-width: 520px;
            margin: 0 auto;
        }
        .project-card{
            background:#f7f4ee;
            color:#1f1f1f;
            border-radius:16px;
            padding:18px;
            box-shadow:0 14px 30px rgba(0,0,0,.35);
            cursor:pointer;
            position:relative;
            overflow:hidden;
            aspect-ratio:16/9;
            width:380px;
            display:flex;
            align-items:center;
            justify-content:center;
            text-align:center;
            background-image:
                    linear-gradient(transparent 95%, rgba(0,0,0,.08) 0),
                    linear-gradient(120deg, rgba(255,255,255,.7), rgba(255,255,255,.2));
            background-size:100% 30px, 100% 100%;
        }
        .project-card h3{
            font-size:20px;
            margin:0;
        }
        .project-item{
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:6px;
            width:100%;
        }
        .project-updated{
            font-size:11px;
            color:var(--muted);
        }
        .empty-cta{
            padding:42px 0 36px;
            text-align:center;
            color:var(--muted);
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:12px;
            width:100%;
        }
        .empty-cta-icon{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            text-decoration:none;
            color:var(--text);
        }
        .empty-cta-ring{
            width:72px;
            height:72px;
            border-radius:999px;
            border:2px solid var(--icon-ring);
            display:flex;
            align-items:center;
            justify-content:center;
            background: rgba(255,255,255,0.03);
            transition: transform .14s ease, border-color .14s ease, background .14s ease;
        }
        .empty-cta-icon:hover .empty-cta-ring{
            transform: translateY(-2px);
            border-color: var(--link-blue);
            background: rgba(90,167,255,0.12);
        }
        .empty-cta-ring svg{
            width:30px;
            height:30px;
            stroke: rgba(255,255,255,.92);
            fill:none;
            stroke-width:1.8;
            transition: stroke .14s ease;
        }
        .empty-cta-icon:hover svg{
            stroke: var(--link-blue);
        }
        .empty-cta-title{
            margin-top: 18px;
            font-size: 28px;
            font-weight: 900;
            letter-spacing: -0.02em;
            color:var(--text);
        }
        .empty-cta-desc{
            margin-top: 10px;
            font-size: 13px;
            color:var(--muted);
            line-height: 1.65;
        }
        .empty-cta-link{
            display:inline-block;
            margin-top: 14px;
            font-size: 14px;
            font-weight: 700;
            color:var(--link-blue);
            text-decoration:none;
        }
        .empty-cta-link:hover{
            text-decoration:underline;
        }
    </style>
</head>
<body>
<div class="page-shell">
    <header class="top-header">
        <div class="header-inner">
            <a href="/" class="back-link" id="backToProfileLink">프로필로 돌아가기</a>
            <div class="header-title">스토리보드 프로젝트</div>
            <div class="header-right" id="headerActions"></div>
        </div>
    </header>

    <main class="wrap">
        <div class="toolbar">
            <button type="button" class="primary-btn" id="createProjectBtn" aria-label="새 프로젝트 추가">+</button>
        </div>

        <div id="projectList" class="grid"></div>
    </main>
</div>

<script src="/js/auth.js"></script>
<script>
    function normalizeMe(me) {
        const username = me?.username ? String(me.username).trim() : "";
        const displayName = (me?.displayName || me?.name || username || me?.email || "내 계정");
        const avatarUrl = me?.avatarUrl || me?.profileImageUrl || me?.profileImage || "";
        return { username, displayName, avatarUrl };
    }

    function renderLoggedOut(container) {
        container.innerHTML = `<button type="button" class="login-btn" id="loginBtn">로그인</button>`;
        container.querySelector("#loginBtn")?.addEventListener("click", () => {
            const next = encodeURIComponent(location.pathname + location.search);
            window.location.href = `/login.html?next=${next}`;
        });
    }

    function renderLoggedIn(container, me) {
        const { username, displayName, avatarUrl } = normalizeMe(me);
        const baseForInitial = username || displayName;
        const initial = (baseForInitial.trim().charAt(0) || "A").toUpperCase();

        container.innerHTML = `
      <div class="profile-menu">
        <button type="button" class="profile-avatar-btn" id="profileAvatarBtn" aria-label="계정 메뉴 열기">
          ${
            avatarUrl
                    ? `<img src="${avatarUrl}" alt="${displayName} 프로필" />`
                    : `<span class="profile-avatar-initial">${initial}</span>`
          }
        </button>

        <div class="profile-dropdown" id="profileDropdown">
          <div class="profile-group-title">${displayName}</div>

          <button type="button" class="profile-item" data-action="actor-page">
            프로필
            <span>프로필 보기</span>
          </button>

          <div class="profile-divider"></div>
          <div class="profile-group-title">편집</div>

          <button type="button" class="profile-item" data-action="edit-profile">
            프로필 편집
            <span>기본정보</span>
          </button>

          <button type="button" class="profile-item" data-action="edit-filmography">
            필모그래피 편집
            <span>작품/역할</span>
          </button>

          <button type="button" class="profile-item" data-action="edit-gallery">
            갤러리 편집
            <span>사진/영상</span>
          </button>

          <div class="profile-divider"></div>
          <div class="profile-group-title">스토리보드</div>

          <button type="button" class="profile-item" data-action="storyboard-projects">
            프로젝트 목록
            <span>스토리보드 보관함</span>
          </button>

          <button type="button" class="profile-item" data-action="storyboard-edit">
            스토리보드 편집
            <span>대본/컷 작업</span>
          </button>

          <div class="profile-divider"></div>

          <button type="button" class="profile-item" data-action="account-settings">
            계정 설정
            <span>비밀번호/연동</span>
          </button>

          <button type="button" class="profile-item" data-action="logout">
            로그아웃
          </button>
        </div>
      </div>
    `;
    }

    function attachProfileMenuHandlers(me) {
        const avatarBtn = document.getElementById("profileAvatarBtn");
        const dropdown  = document.getElementById("profileDropdown");
        if (!avatarBtn || !dropdown) return;

        const close = () => dropdown.classList.remove("open");

        avatarBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdown.classList.toggle("open");
        });

        dropdown.querySelectorAll(".profile-item").forEach(btn => {
            btn.addEventListener("click", async () => {
                const action = btn.dataset.action;
                close();

                if (action === "actor-page") {
                    const uname = (me?.username ? String(me.username).trim() : "");
                    if (!uname) {
                        window.location.href = "/edit-profile.html";
                        return;
                    }
                    try {
                        const publicIdRes = await fetch(`/api/person/${encodeURIComponent(uname)}`, {
                            headers: { "Accept": "application/json" }
                        });
                        if (!publicIdRes.ok) {
                            window.location.href = "/edit-profile.html";
                            return;
                        }
                        const ct = publicIdRes.headers.get("content-type") || "";
                        let publicId = null;
                        if (ct.includes("application/json")) {
                            const data = await publicIdRes.json().catch(() => null);
                            publicId = (typeof data === "string")
                                    ? data.trim()
                                    : (data?.publicId || data?.id || data?.personPublicId || data?.personId || "");
                        } else {
                            publicId = (await publicIdRes.text().catch(() => "")).trim();
                        }
                        if (!publicId) {
                            window.location.href = "/edit-profile.html";
                            return;
                        }
                        const profileRes = await fetch(`/api/people/${encodeURIComponent(publicId)}`, {
                            headers: { "Accept": "application/json" }
                        });
                        if (!profileRes.ok) {
                            window.location.href = "/edit-profile.html";
                            return;
                        }
                        const p = await profileRes.json().catch(() => null);
                        const hasOther =
                                !!(p?.oneLineIntro && String(p.oneLineIntro).trim()) ||
                                !!(p?.birthDate && String(p.birthDate).trim()) ||
                                !!(p?.birthPlace && String(p.birthPlace).trim()) ||
                                !!(p?.profileImageUrl && String(p.profileImageUrl).trim()) ||
                                (Array.isArray(p?.snsList) && p.snsList.length > 0) ||
                                (Array.isArray(p?.rawTags) && p.rawTags.length > 0);
                        if (!hasOther) {
                            window.location.href = "/edit-profile.html";
                            return;
                        }
                        window.location.href = "/onfilm/" + encodeURIComponent(uname);
                    } catch (e) {
                        window.location.href = "/edit-profile.html";
                    }
                }

                if (action === "edit-profile") { window.location.href = "edit-profile.html"; return; }
                if (action === "edit-filmography") { window.location.href = "edit-filmography.html"; return; }
                if (action === "edit-gallery") { window.location.href = "edit-gallery.html"; return; }
                if (action === "storyboard-projects") { window.location.href = "storyboard.html"; return; }
                if (action === "storyboard-edit") { window.location.href = "edit-storyboard.html"; return; }
                if (action === "account-settings") { window.location.href = "account-settings.html"; return; }
                if (action === "logout") {
                    await window.OnfilmAuth.logout();
                    window.location.href = "index.html";
                }
            });
        });

        document.addEventListener("click", (e) => {
            if (!dropdown.contains(e.target) && e.target !== avatarBtn) close();
        });
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") close();
        });
    }
    const projectList = document.getElementById("projectList");
    const createProjectBtn = document.getElementById("createProjectBtn");
    const backToProfileLink = document.getElementById("backToProfileLink");

    function authFetch(url, options = {}) {
        if (window.OnfilmAuth?.apiFetchWithAutoRefresh) {
            return window.OnfilmAuth.apiFetchWithAutoRefresh(url, options);
        }
        return fetch(url, options);
    }

    async function fetchPublicIdByUsername(username){
        const res = await authFetch(`/api/person/${encodeURIComponent(username)}`, {
            headers: { "Accept": "application/json" }
        });
        if (!res.ok) throw new Error("PUBLIC_ID_NOT_FOUND");
        const ct = res.headers.get("content-type") || "";
        if (ct.includes("application/json")) {
            const data = await res.json().catch(() => null);
            if (typeof data === "string") return data.trim();
            return data?.publicId || data?.id || data?.personPublicId || data?.personId || "";
        }
        return (await res.text().catch(() => "")).trim();
    }

    function renderEmpty(){
        projectList.classList.add("empty-mode");
        projectList.innerHTML = `
            <div class="empty-cta">
                <a class="empty-cta-icon" href="/edit-storyboard.html" aria-label="스토리보드 등록하기">
                    <span class="empty-cta-ring">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 4.5h8.2a2.3 2.3 0 0 1 2.3 2.3v12.7H8.5A2.5 2.5 0 0 0 6 22V4.5Z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 7.2H18a2 2 0 0 1 2 2v10.6H8.5A2.5 2.5 0 0 0 6 22h11.5"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.5 8.6h6.2M8.5 11.6h6.2M8.5 14.6h6.2"/>
                      </svg>
                    </span>
                </a>

                <div class="empty-cta-title">스토리보드 업로드</div>
                <div class="empty-cta-desc">스토리보드를 등록하면 보관함에 표시됩니다</div>
                <a class="empty-cta-link" href="/edit-storyboard.html">첫 스토리보드 등록하기</a>
            </div>
        `;
    }

    function renderProjects(projects){
        if (!Array.isArray(projects) || projects.length === 0) {
            renderEmpty();
            return;
        }
        projectList.classList.remove("empty-mode");
        projectList.innerHTML = projects.map(project => {
            const updatedIso = localStorage.getItem(`onfilm.storyboard.updated.${project.projectId}`) || "";
            const updatedText = formatUpdatedAt(updatedIso);
            return `
                <div class="project-item">
                    <article class="project-card" data-project-id="${project.projectId}">
                        <h3>${escapeHtml(project.title || "제목 없음")}</h3>
                    </article>
                    <div class="project-updated">${escapeHtml(updatedText)}</div>
                </div>
            `;
        }).join("");
    }

    function escapeHtml(value){
        return String(value || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function formatUpdatedAt(iso){
        if (!iso) return "";
        const dt = new Date(iso);
        if (Number.isNaN(dt.getTime())) return "";
        const y = dt.getFullYear();
        const m = dt.getMonth() + 1;
        const d = dt.getDate();
        const hh = String(dt.getHours()).padStart(2, "0");
        const mm = String(dt.getMinutes()).padStart(2, "0");
        return `수정한 날짜: ${y}·${m}·${d}·${hh}:${mm}`;
    }


    async function init(){
        if (!window.OnfilmAuth?.restoreSession) return;
        const result = await window.OnfilmAuth.restoreSession();
        if (!result?.ok) {
            const next = encodeURIComponent(location.pathname + location.search);
            location.href = `/login.html?next=${next}`;
            return;
        }
        const headerActions = document.getElementById("headerActions");
        if (headerActions) {
            renderLoggedIn(headerActions, result.me);
            attachProfileMenuHandlers(result.me);
        }
        const me = result.me;
        const uname = me?.username ? String(me.username).trim() : "";
        if (!uname) {
            renderEmpty();
            return;
        }
        if (backToProfileLink) {
            backToProfileLink.href = "/onfilm/" + encodeURIComponent(uname);
        }

        const publicId = await fetchPublicIdByUsername(uname);
        const res = await authFetch(`/api/people/${encodeURIComponent(publicId)}/storyboard/projects`, {
            headers: { "Accept": "application/json" }
        });
        if (!res.ok) throw new Error("LOAD_FAILED");
        const projects = await res.json().catch(() => []);
        renderProjects(projects);

        projectList.addEventListener("click", async (e) => {
            const card = e.target.closest(".project-card");
            if (!card) return;
            const projectId = card.dataset.projectId;
            if (!projectId) return;
            location.href = `/storyboard-view.html?projectId=${encodeURIComponent(projectId)}`;
        });

        createProjectBtn?.addEventListener("click", () => {
            location.href = "/edit-storyboard.html";
        });
    }

    document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
